<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="UTF-8">
    <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="images/favicon.png" rel="shortcut icon">
    <title>Kardiy - Elegant - Fast - Reliable - Cheap</title>

    <!--====== Google Font ======-->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet">

    <!--====== Vendor Css ======-->
    <link rel="stylesheet" href="css/vendor.css">

    <!--====== Utility-Spacing ======-->
    <link rel="stylesheet" href="css/utility.css">

    <!--====== App ======-->
    <link rel="stylesheet" href="css/app.css">
    <script src="user.js"></script>
</head>
<body class="config">
    <div class="preloader is-active">
        <div class="preloader__wrap">

            <img class="preloader__img" src="images/preloader.png" alt=""></div>
    </div>

    <!--====== Main App ======-->
    <div id="app">

        <!--====== Main Header ======-->
        <div id="header-placeholder"></div>
        <script>
        (async () => {
        const el = document.getElementById('header-placeholder');
        const resp = await fetch('top_bar.html?_=' + Date.now()); // bust cache
        const html = await resp.text();
        el.innerHTML = html;

        document.dispatchEvent(new CustomEvent('user:changed'));

        // Execute any <script> tags inside the injected HTML
        el.querySelectorAll('script').forEach((old) => {
            const s = document.createElement('script');
            if (old.src) {
            s.src = old.src; s.async = old.async; s.defer = old.defer || false;
            } else {
            s.textContent = old.textContent;
            }
            document.head.appendChild(s);
        });

        // Call menu builder with already-fetched products if we have them
        const tryInit = () => {
            if (typeof window.initHeaderMenu === 'function') {
            window.initHeaderMenu(window.__ALL_PRODUCTS__ || null);
            }
        };
        // tiny delay to ensure the function is defined
        setTimeout(tryInit, 0);
        })();
        </script>
        <!--====== End - Main Header ======-->



        <!--====== App Content ======-->
        <div class="app-content">

            <!--====== Section 1 ======-->
            <div class="u-s-p-y-60">

                <!--====== Section Content ======-->
                <div class="section__content">
                    <div class="container">
                        <div class="breadcrumb">
                            <div class="breadcrumb__wrap">
                                <ul class="breadcrumb__list">
                                    <li class="has-separator">

                                        <a href="index.html">Home</a></li>
                                    <li class="is-marked">

                                        <a href="dash-my-profile.html">My Account</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--====== End - Section 1 ======-->


            <!--====== Section 2 ======-->
            <div class="u-s-p-b-60">

                <!--====== Section Content ======-->
                <div class="section__content">
                    <div class="dash">
                        <div class="container">
                            <div class="row">
                                <div class="col-lg-3 col-md-12">

                                    <!--====== Dashboard Features ======-->
                                    <div class="dash__box dash__box--bg-white dash__box--shadow u-s-m-b-30">
                                        <div class="dash__pad-1">

                                            <span class="dash__text u-s-m-b-16" data-profile-greeting data-user-hello>Hello, Guest</span>
                                            <ul class="dash__f-list">
                                                <li>

                                                    <a href="dashboard.html">Manage My Account</a></li>
                                                <li>

                                                    <a class="dash-active" href="dash-my-profile.html">My Profile</a></li>
                                                <li>

                                                    <a href="dash-address-book.html">Address Book</a></li>
                                                <li>

                                                    <a href="dash-track-order.html">Track Order</a></li>
                                                <li>

                                                    <a href="dash-my-order.html">My Orders</a></li>
                                                <li>

                                                    <a href="dash-payment-option.html">My Payment Options</a></li>
                                                <li>

                                                    <a href="dash-cancellation.html">My Returns & Cancellations</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="dash__box dash__box--bg-white dash__box--shadow dash__box--w">
                                        <div class="dash__pad-1">
                                            <ul class="dash__w-list">
                                                <li>
                                                    <div class="dash__w-wrap">

                                                        <span class="dash__w-icon dash__w-icon-style-1"><i class="fas fa-cart-arrow-down"></i></span>

                                                        <span class="dash__w-text">4</span>

                                                        <span class="dash__w-name">Orders Placed</span></div>
                                                </li>
                                                <li>
                                                    <div class="dash__w-wrap">

                                                        <span class="dash__w-icon dash__w-icon-style-2"><i class="fas fa-times"></i></span>

                                                        <span class="dash__w-text">0</span>

                                                        <span class="dash__w-name">Cancel Orders</span></div>
                                                </li>
                                                <li>
                                                    <div class="dash__w-wrap">

                                                        <span class="dash__w-icon dash__w-icon-style-3"><i class="far fa-heart"></i></span>

                                                        <span class="dash__w-text">0</span>

                                                        <span class="dash__w-name">Wishlist</span></div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <!--====== End - Dashboard Features ======-->
                                </div>
                                <div class="col-lg-9 col-md-12">
                                    <div class="dash__box dash__box--shadow dash__box--radius dash__box--bg-white u-s-m-b-30">
                                        <div class="dash__pad-2">
                                            <h1 class="dash__h1 u-s-m-b-14">My Profile</h1>

                                            <span class="dash__text u-s-m-b-30">Look all your info, you could customize your profile.</span>
                                            <div class="row">
                                                <div class="col-lg-4 u-s-m-b-30">
                                                    <h2 class="dash__h2 u-s-m-b-8">Full Name</h2>

                                                    <span class="dash__text" data-profile-name>—</span>
                                                </div>
                                                <div class="col-lg-4 u-s-m-b-30">
                                                    <h2 class="dash__h2 u-s-m-b-8">E-mail</h2>

                                                    <span class="dash__text" data-profile-email>—</span>
                                                    <div class="dash__link dash__link--secondary">

                                                        <a href="#" data-action="open-profile-edit">Change</a></div>
                                                </div>
                                                <div class="col-lg-4 u-s-m-b-30">
                                                    <h2 class="dash__h2 u-s-m-b-8">Phone</h2>

                                                    <span class="dash__text" data-profile-phone>Add your phone</span>
                                                    <div class="dash__link dash__link--secondary">

                                                        <a href="#" data-action="open-profile-edit">Add</a></div>
                                                </div>
                                                <div class="col-lg-4 u-s-m-b-30">
                                                    <h2 class="dash__h2 u-s-m-b-8">Birthday</h2>

                                                    <span class="dash__text" data-profile-birthday>—</span>
                                                </div>
                                                <div class="col-lg-4 u-s-m-b-30">
                                                    <h2 class="dash__h2 u-s-m-b-8">Gender</h2>

                                                    <span class="dash__text" data-profile-gender>—</span>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-lg-12">
                                                    <div class="dash__link dash__link--secondary u-s-m-b-30">

                                                        <a data-modal="modal" data-modal-id="#dash-newsletter">Subscribe Newsletter</a></div>
                                                    <div class="u-s-m-b-16">

                                                        <button type="button" class="dash__custom-link btn--e-transparent-brand-b-2" data-action="open-profile-edit">Edit Profile</button></div>
                                                    <div>

                                                        <a class="dash__custom-link btn--e-brand-b-2" href="#">Change Password</a></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--====== End - Section Content ======-->
            </div>
            <!--====== End - Section 2 ======-->
        </div>
        <!--====== End - App Content ======-->


        <!--====== Main Footer ======-->
        <div id="footer-placeholder"></div>
        <script>
        (async () => {
            const el = document.getElementById('footer-placeholder');
            const resp = await fetch('footer.html?_=' + Date.now()); // Fetch footer.html
            const html = await resp.text();
            el.innerHTML = html;
        })();
        </script>
        </div>

        <!--====== Modal Section ======-->


        <!--====== Profile Edit Modal ======-->
        <div class="modal fade" id="profile-edit-modal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content modal--shadow">
                    <div class="modal-body">
                        <form id="profile-edit-form" class="d-modal__form">
                            <div class="u-s-m-b-25">
                                <h1 class="gl-modal-h1">Edit Profile</h1>
                                <span class="gl-text">Update your personal details below.</span>
                            </div>
                            <div class="row">
                                <div class="col-lg-6 u-s-m-b-15">
                                    <label class="gl-label" for="profile-first-name">First Name<span class="astk">*</span></label>
                                    <input class="input-text input-text--primary-style" type="text" id="profile-first-name" name="firstName" required>
                                </div>
                                <div class="col-lg-6 u-s-m-b-15">
                                    <label class="gl-label" for="profile-last-name">Last Name</label>
                                    <input class="input-text input-text--primary-style" type="text" id="profile-last-name" name="lastName">
                                </div>
                                <div class="col-lg-6 u-s-m-b-15">
                                    <label class="gl-label" for="profile-email">Email<span class="astk">*</span></label>
                                    <input class="input-text input-text--primary-style" type="email" id="profile-email" name="email" required>
                                </div>
                                <div class="col-lg-6 u-s-m-b-15">
                                    <label class="gl-label" for="profile-phone">Phone</label>
                                    <input class="input-text input-text--primary-style" type="tel" id="profile-phone" name="phone" placeholder="Add your phone">
                                </div>
                                <div class="col-lg-6 u-s-m-b-15">
                                    <label class="gl-label" for="profile-birthday">Birthday</label>
                                    <input class="input-text input-text--primary-style" type="date" id="profile-birthday" name="birthday">
                                </div>
                                <div class="col-lg-6 u-s-m-b-15">
                                    <label class="gl-label" for="profile-gender">Gender</label>
                                    <div class="select-box select-box--primary-style">
                                        <select class="select-box__select" id="profile-gender" name="gender">
                                            <option value="">Prefer not to say</option>
                                            <option value="Female">Female</option>
                                            <option value="Male">Male</option>
                                            <option value="Non-binary">Non-binary</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <p class="gl-text u-s-m-t-16" id="profile-edit-status"></p>
                            <div class="gl-modal-btn-group">

                                <button class="btn btn--e-brand-b-2" type="submit">Save Changes</button>

                                <button class="btn btn--e-grey-b-2" type="button" data-dismiss="modal">Cancel</button></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!--====== End - Profile Edit Modal ======-->

        <!--====== Unsubscribe or Subscribe Newsletter ======-->
        <div class="modal fade" id="dash-newsletter">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content modal--shadow">
                    <div class="modal-body">
                        <form class="d-modal__form">
                            <div class="u-s-m-b-15">
                                <h1 class="gl-modal-h1">Newsletter Subscription</h1>

                                <span class="gl-modal-text">I have read and understood</span>

                                <a class="d_modal__link" href="dash-my-profile.html">Ludus Privacy Policy</a>
                            </div>
                            <div class="gl-modal-btn-group">

                                <button class="btn btn--e-brand-b-2" type="submit">SUBSCRIBE</button>

                                <button class="btn btn--e-grey-b-2" type="button" data-dismiss="modal">CANCEL</button></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!--====== Unsubscribe or Subscribe Newsletter ======-->
        <!--====== End - Modal Section ======-->
    </div>
    <!--====== End - Main App ======-->


    <!--====== Google Analytics: change UA-XXXXX-Y to be your site's ID ======-->
    <script>
        window.ga = function() {
            ga.q.push(arguments)
        };
        ga.q = [];
        ga.l = +new Date;
        ga('create', 'UA-XXXXX-Y', 'auto');
        ga('send', 'pageview')
    </script>
    <script src="https://www.google-analytics.com/analytics.js" async defer></script>

    <!--====== Vendor Js ======-->
    <script src="js/vendor.js"></script>

    <!--====== jQuery Shopnav plugin ======-->
    <script src="js/jquery.shopnav.js"></script>

    <!--====== App ======-->
    <script src="js/app.js"></script>

    <!--====== Noscript ======-->
    <noscript>
        <div class="app-setting">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="app-setting__wrap">
                            <h1 class="app-setting__h1">JavaScript is disabled in your browser.</h1>

                            <span class="app-setting__text">Please enable JavaScript in your browser or upgrade to a JavaScript-capable browser.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </noscript>

<script>
(() => {
  const select = (selector, parent = document) => (parent ? parent.querySelector(selector) : null);
  const selectAll = (selector, parent = document) => (parent ? Array.from(parent.querySelectorAll(selector)) : []);
  const toStringSafe = (value, fallback = '') => (value == null ? fallback : String(value));
  const sanitize = (value) => (typeof value === 'string' ? value.trim() : '');
  const nullIfEmpty = (value) => (value === '' ? null : value);
  const displayValue = (value, fallback) => {
    const clean = sanitize(value);
    return clean ? clean : fallback;
  };
  const knownGenderOptions = ['Female', 'Male', 'Non-binary', 'Other'];
  const normalizeGender = (value) => {
    const clean = sanitize(value);
    if (!clean) return '';
    const match = knownGenderOptions.find((option) => option.toLowerCase() === clean.toLowerCase());
    return match || clean;
  };
  let sessionSettled = false;

  const editButtons = selectAll('[data-action="open-profile-edit"]');
  const editModal = document.getElementById('profile-edit-modal');
  const editForm = document.getElementById('profile-edit-form');
  const statusNode = document.getElementById('profile-edit-status');
  const formFields = editForm ? {
    firstName: select('[name="firstName"]', editForm),
    lastName: select('[name="lastName"]', editForm),
    email: select('[name="email"]', editForm),
    phone: select('[name="phone"]', editForm),
    birthday: select('[name="birthday"]', editForm),
    gender: select('[name="gender"]', editForm)
  } : null;

  const resetStatusClass = (el) => {
    if (!el) return;
    el.className = 'gl-text u-s-m-t-16';
  };

  const normalizeDateInput = (value) => {
    if (!value) return '';
    if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
      return value;
    }
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) {
      return value;
    }
    return date.toISOString().split('T')[0];
  };

  const showStatus = (message, tone = 'info') => {
    if (!statusNode) return;
    resetStatusClass(statusNode);
    if (tone === 'error') {
      statusNode.classList.add('u-c-brand');
    } else if (tone === 'success') {
      statusNode.classList.add('u-c-secondary');
    }
    statusNode.textContent = message;
  };

  const clearStatus = () => {
    if (!statusNode) return;
    resetStatusClass(statusNode);
    statusNode.textContent = '';
  };

  const openModal = (modal) => {
    if (!modal) return;
    if (window.jQuery && window.jQuery.fn && typeof window.jQuery.fn.modal === 'function') {
      window.jQuery(modal).modal('show');
    } else {
      modal.classList.add('show');
      modal.style.display = 'block';
      modal.removeAttribute('aria-hidden');
      document.body.classList.add('modal-open');
      if (!document.querySelector('.modal-backdrop')) {
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(backdrop);
      }
    }
  };

  const closeModal = (modal) => {
    if (!modal) return;
    if (window.jQuery && window.jQuery.fn && typeof window.jQuery.fn.modal === 'function') {
      window.jQuery(modal).modal('hide');
    } else {
      modal.classList.remove('show');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('modal-open');
      const backdrop = document.querySelector('.modal-backdrop');
      if (backdrop) {
        backdrop.remove();
      }
    }
  };

  const fillForm = (user) => {
    if (!formFields) return;
    if (!user) {
      editForm.reset();
      return;
    }
    formFields.firstName.value = toStringSafe(user.user_name);
    formFields.lastName.value = toStringSafe(user.user_surname);
    formFields.email.value = toStringSafe(user.user_email);
    formFields.phone.value = toStringSafe(user.user_phone);
    formFields.birthday.value = normalizeDateInput(toStringSafe(user.user_birthday));
    formFields.gender.value = normalizeGender(user.user_gender);
  };

  const applyProfile = (user) => {
    if (!user) {
      return;
    }

    const firstName = user.user_name || '';
    const lastName = user.user_surname || '';
    const fullName = [firstName, lastName].filter(Boolean).join(' ') || user.user_email || 'Customer';

    const profileData = {
      greeting: `Hello, ${fullName}`,
      name: fullName,
      email: displayValue(user.user_email, 'Not provided'),
      phone: displayValue(user.user_phone, 'Add your phone'),
      birthday: displayValue(normalizeDateInput(user.user_birthday), '—'),
      gender: displayValue(normalizeGender(user.user_gender), '—')
    };

    Object.entries(profileData).forEach(([key, value]) => {
      const el = select(`[data-profile-${key}]`);
      if (el) {
        el.textContent = value;
      }
    });

    fillForm(user);
  };

  const updateProfile = (user) => {
    if (!user) {
      fillForm(null);
      if (sessionSettled) {
        window.location.href = 'signin.html';
      }
      return;
    }

    applyProfile(user);
    document.dispatchEvent(new CustomEvent('user:profileLoaded', { detail: user }));
  };

  editButtons.forEach((button) => {
    button.addEventListener('click', (event) => {
      event.preventDefault();
      const user = window.getCurrentUser?.();
      if (!user) {
        window.location.href = 'signin.html';
        return;
      }
      fillForm(user);
      clearStatus();
      openModal(editModal);
    });
  });

  if (editForm) {
    editForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!formFields) return;

      clearStatus();

      const payload = {
        user_name: sanitize(formFields.firstName.value),
        user_surname: sanitize(formFields.lastName.value),
        user_email: sanitize(formFields.email.value),
        user_phone: nullIfEmpty(sanitize(formFields.phone.value)),
        user_birthday: nullIfEmpty(formFields.birthday.value),
        user_gender: nullIfEmpty(normalizeGender(formFields.gender.value))
      };

      if (!payload.user_name) {
        showStatus('First name is required.', 'error');
        formFields.firstName.focus();
        return;
      }

      if (!payload.user_email) {
        showStatus('Email is required.', 'error');
        formFields.email.focus();
        return;
      }

      showStatus('Saving changes...', 'info');

      try {
        const response = await fetch(`${API_ROOT}/auth/profile`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        if (response.status === 401) {
          window.location.href = 'signin.html';
          return;
        }

        const result = await response.json().catch(() => ({}));

        if (!response.ok) {
          throw new Error(result?.error || 'Unable to update profile.');
        }

        if (typeof window.setCurrentUser === 'function') {
          window.setCurrentUser(result);
        } else {
          document.dispatchEvent(new CustomEvent('user:changed', { detail: result }));
        }

        showStatus('Profile updated!', 'success');
        setTimeout(() => {
          clearStatus();
          closeModal(editModal);
        }, 600);
      } catch (error) {
        console.error(error);
        showStatus(error.message || 'Unable to update profile.', 'error');
      }
    });
  }

  const init = async () => {
    const current = window.getCurrentUser?.();
    if (!current && typeof window.checkSession === 'function') {
      await window.checkSession();
    }

    sessionSettled = true;
    updateProfile(window.getCurrentUser?.());
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  document.addEventListener('user:changed', (event) => {
    const userData = event?.detail ?? window.getCurrentUser?.();
    if (!sessionSettled && !userData) {
      return;
    }
    updateProfile(userData);
  });
})();
</script>

</body>
</html>