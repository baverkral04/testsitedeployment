<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="UTF-8">
    <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="images/favicon.png" rel="shortcut icon">
    <title>Kardiy - Elegant - Fast - Reliable - Cheap</title>

    <!--====== Google Font ======-->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet">

    <!--====== Vendor Css ======-->
    <link rel="stylesheet" href="css/vendor.css">

    <!--====== Utility-Spacing ======-->
    <link rel="stylesheet" href="css/utility.css">

    <!--====== App ======-->
    <link rel="stylesheet" href="css/app.css">
    <script src="user.js"></script>

    
    <style>
        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error message styling */
        .error-message {
            background-color: #ffebee;
            color: #b71c1c;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
        }
        
        /* Product policy styling */
        .pd-detail__policy-list li {
            margin-bottom: 8px;
        }
        
        /* Color selector styling */
        .color__radio {
            display: inline-block;
            margin-right: 10px;
        }
        
        .color__radio-label {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid #ddd;
        }
        
        .color__radio input[type="radio"] {
            display: none;
        }
        
        .color__radio input[type="radio"]:checked + .color__radio-label {
            border: 2px solid #000;
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px #000;
        }
        
        /* Size selector styling */
        .size__radio {
            display: inline-block;
            margin-right: 10px;
        }
        
        .size__radio-label {
            display: inline-block;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .size__radio input[type="radio"] {
            display: none;
        }
        
        .size__radio input[type="radio"]:checked + .size__radio-label {
            border-color: #000;
            background-color: #f8f8f8;
            font-weight: bold;
        }
        
        /* Quantity input styling */
        .input-counter {
            display: inline-flex;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .input-counter__minus,
        .input-counter__plus {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f8f8;
            cursor: pointer;
            border: none;
        }
        
        .input-counter__text {
            width: 60px;
            height: 40px;
            text-align: center;
            border: none;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
        }
        
        /* Social media icons */
        .pd-social-list {
            display: flex;
            padding: 0;
            margin: 0;
        }
        
        .pd-social-list li {
            list-style: none;
            margin-right: 15px;
        }
        
        .pd-social-list a {
            font-size: 20px;
        }
        
        /* Related products section */
        .section__intro {
            margin-bottom: 30px;
        }
        
        .product-slider {
            display: flex;
            flex-wrap: wrap;
        }
        
        .product-o {
            margin-bottom: 30px;
        }
        .pd-tab__desc {
                white-space: pre-line;
            }
        /* ===== Simple JS/CSS gallery – no external slider required ===== */
        .gallery-main{width:100%;margin-bottom:15px;}
        .gallery-main img{width:100%;height:auto;display:block;}
        .gallery-thumbs{display:flex;gap:10px;overflow-x:auto;padding-bottom:5px;}
        .gallery-thumbs img{width:80px;height:80px;object-fit:cover;cursor:pointer;border:2px solid transparent;border-radius:4px;flex-shrink:0;}
        .gallery-thumbs img.active{border-color:#3498db;}
        /* Hide placeholder single‑image container – gallery now handles main image */
        #main-image-container{display:none;}
    </style>
</head>
<body class="config">
    <div class="preloader is-active">
        <div class="preloader__wrap">
            <img class="preloader__img" src="images/preloader.png" alt="">
        </div>
    </div>
    
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <!--====== Main App ======-->
    <div id="app">
        <!--====== Main Header ======-->
       <div id="header-placeholder"></div>
        <script>
        (async () => {
        const el = document.getElementById('header-placeholder');
        const resp = await fetch('top_bar.html?_=' + Date.now()); // bust cache
        const html = await resp.text();
        el.innerHTML = html;

        // Execute any <script> tags inside the injected HTML

        document.dispatchEvent(new CustomEvent('user:changed'));
    
        el.querySelectorAll('script').forEach((old) => {
            const s = document.createElement('script');
            if (old.src) {
            s.src = old.src; s.async = old.async; s.defer = old.defer || false;
            } else {
            s.textContent = old.textContent;
            }
            document.head.appendChild(s);
        });

        // Call menu builder with already-fetched products if we have them
        const tryInit = () => {
            if (typeof window.initHeaderMenu === 'function') {
            window.initHeaderMenu(window.__ALL_PRODUCTS__ || null);
            }
        };
        // tiny delay to ensure the function is defined
        setTimeout(tryInit, 0);
        })();
        </script>
        <!--====== End - Main Header ======-->

        <!--====== App Content ======-->
        <div class="app-content">
            <!--====== Section 1 ======-->
            <div class="u-s-p-t-90">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-5">
                            <!-- Product Breadcrumb (will be populated dynamically) -->
                            <div class="pd-breadcrumb u-s-m-b-30" id="product-breadcrumb">
                                <!-- Breadcrumb will be generated here -->
                            </div>
                            
                            <!-- Main product image placeholder -->
                            <div class="pd u-s-m-b-30" id="main-image-container">
                                <img id="main-page-image" class="u-img-fluid" src="" alt="Main Product Image">
                            </div>
                            <!-- Product Image Gallery (will be populated dynamically) -->
                            <div class="pd u-s-m-b-30" id="product-gallery">
                                <!-- Gallery will be generated here -->
                            </div>
                        </div>
                        <div class="col-lg-7">
                            <!-- Product Details (will be populated dynamically) -->
                            <div class="pd-detail" id="product-details">
                                <!-- Details will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--====== Product Detail Tab ======-->
            <div class="u-s-p-y-90">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="pd-tab">
                                <div class="u-s-m-b-30">
                                    <ul class="nav pd-tab__list">
                                        <li class="nav-item">
                                            <a class="nav-link" data-toggle="tab" href="#pd-desc">DESCRIPTION</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-toggle="tab" href="#pd-tag">TAGS</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link active" id="view-review" data-toggle="tab" href="#pd-rev">REVIEWS</a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="tab-content">
                                    <!-- Description Tab -->
                                    <div class="tab-pane" id="pd-desc">
                                        <div class="pd-tab__desc" id="product-description">
                                            <!-- Description will be generated here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Tags Tab -->
                                    <div class="tab-pane" id="pd-tag">
                                        <div class="pd-tab__tag">
                                            <h2 class="u-s-m-b-15">ADD YOUR TAGS</h2>
                                            <div class="u-s-m-b-15">
                                                <form>
                                                    <input class="input-text input-text--primary-style" type="text">
                                                    <button class="btn btn--e-brand-b-2" type="submit">ADD TAGS</button>
                                                </form>
                                            </div>
                                            <span class="gl-text">Use spaces to separate tags. Use single quotes (') for phrases.</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Reviews Tab -->
                                    <div class="tab-pane fade show active" id="pd-rev">
                                        <div class="pd-tab__rev" id="product-reviews">
                                            <!-- Reviews will be generated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Customer Also Viewed Section -->
            <div class="u-s-p-b-90">
                <div class="section__intro u-s-m-b-46">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="section__text-wrap">
                                    <h1 class="section__heading u-c-secondary u-s-m-b-12">CUSTOMER ALSO VIEWED</h1>
                                    <span class="section__span u-c-grey">PRODUCTS THAT CUSTOMER VIEWED</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section__content">
                    <div class="container">
                        <div class="row" id="related-products">
                            <!-- Related products will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--====== End - App Content ======-->

        <!--====== Main Footer ======-->
        <div id="footer-placeholder"></div>
        <script>
        (async () => {
            const el = document.getElementById('footer-placeholder');
            const resp = await fetch('footer.html?_=' + Date.now()); // Fetch footer.html
            const html = await resp.text();
            el.innerHTML = html;
        })();
        </script>
        </div>
        <!--====== End - Main Footer ======-->

        <!--====== Modal Section ======-->
        <!-- Modal content remains the same as in your original file -->
        <!--====== End - Modal Section ======-->
    </div>
    <!--====== End - Main App ======-->

    <!--====== Vendor Js ======-->
    <script src="js/vendor.js"></script>

    <!--====== jQuery Shopnav plugin ======-->
    <script src="js/jquery.shopnav.js"></script>

    <!--====== User State (current user helpers) ======-->

    <!--====== App ======-->
    <script src="js/app.js"></script>

    <!-- Product Detail Page Script -->
    <script>
    (async () => {
        // ========== CONFIGURATION ==========
        const DEBUG = true;
        const log = (...args) => DEBUG && console.log('[DEBUG]', ...args);
        const PRODUCTS_API = `${API_ROOT}/products`;
        const USER_API = `${API_ROOT}/users`;
        const IMAGE_FALLBACK = 'images/product/default.jpg';
        const BLANK_IMAGE = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; // 1×1 transparent GIF
        
        // grab an optional override from the URL
        const urlParams     = new URLSearchParams(window.location.search);
        const overrideImage = urlParams.get('image')
                                ? decodeURIComponent(urlParams.get('image'))
                                : null;



        // Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const productBreadcrumb = document.getElementById('product-breadcrumb');
        const productGallery = document.getElementById('product-gallery');
        const productDetails = document.getElementById('product-details');
        const productDescription = document.getElementById('product-description');
        const productReviews = document.getElementById('product-reviews');
        const relatedProducts = document.getElementById('related-products');
        
        // ========== HELPER FUNCTIONS ==========
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }
        
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }
        
        function showError(message) {
            productDetails.innerHTML = `<div class="error-message">${message}</div>`;
        }
        
        function formatPrice(price) {
            return Number(price).toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            });
        }

        function getUserSafe(){ try { return (typeof getCurrentUser === 'function') ? getCurrentUser() : null; } catch(e){ return null; } }


        async function addToCart(productId, qty) {
            const user = getUserSafe();
            if (!user) {
                window.location.href = 'signin.html';
                return false;
            }
            const product_amount = Math.max(1, parseInt(qty || '1', 10) || 1);

            // --- START: This is the missing logic ---
            // Gather selected options from the dropdowns
            const options = {};
            const optionSelects = document.querySelectorAll('.pd-detail-form-group select');
            optionSelects.forEach(select => {
                // Find the corresponding label for this dropdown
                const label = select.closest('.u-s-m-b-15').querySelector('.pd-detail__label');
                if (label) {
                    const optionName = label.textContent.replace(':', '').trim();
                    options[optionName] = select.value;
                }
            });
            // --- END: Missing logic ---

            // Add the now-populated 'options' object to the payload
            const payload = {
                product_id: productId,
                product_amount,
                options, // This will no longer be empty
                user_id: user.user_id,
                user_email: user.user_email
            };

            const res = await fetch(`${USER_API}/add-to-cart`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error(`Add to cart failed (${res.status})`);
            const updated = await res.json().catch(() => ({}));

            // Local optimistic sync... (rest of the function is the same)
            try {
                const u = getUserSafe() || {};
                let arr = [];
                try {
                    arr = JSON.parse(u.user_cart || '[]');
                } catch (_) {
                    arr = [];
                }
                if (!Array.isArray(arr)) arr = [];
                const sid = String(productId);
                const idx = arr.findIndex(it => String(it?.product_id) === sid);
                if (idx >= 0) {
                    const curAmt = parseInt(arr[idx].product_amount || '1', 10) || 1;
                    arr[idx].product_amount = curAmt + product_amount;
                } else {
                    arr.push({
                        product_id: productId,
                        product_amount,
                        options
                    });
                }
                u.user_cart = JSON.stringify(arr);
                if (updated && updated.user_cart !== undefined) {
                    u.user_cart = updated.user_cart; // prefer server truth
                }
                if (typeof setCurrentUser === 'function') setCurrentUser(u);
            } catch (_) {}
            return true;
        }

// ===== Wishlist helpers (product page) =====
const WISHLIST_ADD_URL    = `${USER_API}/wishlist/add`;
const WISHLIST_REMOVE_URL = `${USER_API}/wishlist/remove`;
const WISHLIST_GET_URL    = `${USER_API}/wishlist`; // GET ?user_id=.. OR ?user_email=..

function parseWishlist(u) {
  if (!u) return [];
  try {
    let arr = JSON.parse(u.user_wishlist || '[]');
    if (!Array.isArray(arr)) arr = [];
    // normalize to [{product_id: "…"}]
    return arr.map(it => {
      if (typeof it === 'string' || typeof it === 'number') return { product_id: String(it) };
      const pid = it?.product_id ?? it?.id ?? it?.rowid;
      return pid != null ? { product_id: String(pid) } : null;
    }).filter(Boolean);
  } catch { return []; }
}
function isInWishlist(u, pid) {
  if (!u) return false;
  const sid = String(pid);
  return parseWishlist(u).some(x => String(x.product_id) === sid);
}
function setHeartActive(active) {
  const icon = document.getElementById('pd-wishlist-icon');
  const text = document.getElementById('pd-wishlist-text');
  if (!icon || !text) return;
  icon.classList.toggle('far', !active);
  icon.classList.toggle('fas',  active);
  text.textContent = active ? 'In Wishlist' : 'Add to Wishlist';
}
function updateWishlistCountDisplay() {
  const u = getUserSafe();
  const el = document.getElementById('pd-wishlist-count');
  if (el) el.textContent = `(${parseWishlist(u).length})`;
}
async function serverWishlistAdd(pid) {
  const u = getUserSafe(); if (!u) throw new Error('not-signed-in');
  const res = await fetch(WISHLIST_ADD_URL, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ user_id: u.user_id, user_email: u.user_email, product_id: String(pid) })
  });
  if (!res.ok) throw new Error('wishlist add failed ' + res.status);
  return res.json();
}
async function serverWishlistRemove(pid) {
  const u = getUserSafe(); if (!u) throw new Error('not-signed-in');
  const res = await fetch(WISHLIST_REMOVE_URL, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ user_id: u.user_id, user_email: u.user_email, product_id: String(pid) })
  });
  if (!res.ok) throw new Error('wishlist remove failed ' + res.status);
  return res.json();
}
async function syncWishlistFromServer() {
  const u = getUserSafe(); if (!u) return;
  const q = u.user_id
    ? `user_id=${encodeURIComponent(u.user_id)}`
    : `user_email=${encodeURIComponent(u.user_email)}`;
  try {
    const res = await fetch(`${WISHLIST_GET_URL}?${q}`);
    if (!res.ok) return;
    const list = await res.json(); // normalized [{product_id:""}]
    const updated = { ...(u || {}), user_wishlist: JSON.stringify(list) };
    if (typeof setCurrentUser === 'function') setCurrentUser(updated);
  } catch (_) {}
}

// Wire the heart on this page
function wireWishlist(product) {
  const btn = document.getElementById('pd-wishlist-btn');
  if (!btn) return;

  // prefer DB product_id; fallback to rowid/URL
  const wishId = String(product.product_id ?? product.rowid ?? new URLSearchParams(location.search).get('product_id'));
  btn.dataset.wishId = wishId;

  const u = getUserSafe();
  setHeartActive(isInWishlist(u, wishId));
  updateWishlistCountDisplay();

  // Optional: background sync to make sure local matches DB
  syncWishlistFromServer().then(() => {
    const u2 = getUserSafe();
    setHeartActive(isInWishlist(u2, wishId));
    updateWishlistCountDisplay();
  });

  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    const user = getUserSafe();
    if (!user) { window.location.href = 'signin.html'; return; }

    const currentlyIn = isInWishlist(user, wishId);
    try {
      const updated = currentlyIn
        ? await serverWishlistRemove(wishId)
        : await serverWishlistAdd(wishId);

      // server returns the updated user row; trust it
      if (typeof setCurrentUser === 'function') setCurrentUser(updated);
      setHeartActive(!currentlyIn);
      updateWishlistCountDisplay();
    } catch (err) {
      console.error('[wishlist]', err);
      alert('Could not update wishlist. Please try again.');
    }
  });
}
        
        function renderStars(rating) {
            rating = Number(rating) || 0;
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5 ? 1 : 0;
            const emptyStars = 5 - fullStars - halfStar;
            
            let starsHTML = '';
            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<i class="fas fa-star"></i>';
            }
            if (halfStar) {
                starsHTML += '<i class="fas fa-star-half-alt"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<i class="far fa-star"></i>';
            }
            return starsHTML;
        }
        // ===== reviews: parse & summarize =====================================
        function getReviewStats(product) {
            let list = [];
            try {
                list = JSON.parse(product.product_reviews || '[]');
                if (!Array.isArray(list)) list = [];
            } catch (_) { list = []; }
            const count = list.length;
            const avg = count > 0
                ? list.reduce((s, r) => s + (Number(r.star) || 0), 0) / count
                : 0;
            return { list, count, avg };
        }
        
        // ========== FETCH PRODUCT DATA ==========
        async function fetchProductData(productId) {
            showLoading();
            try {
                log(`Fetching all products to find ID: ${productId}`);
                const response = await fetch(PRODUCTS_API); // Fetch all products

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const products = await response.json();
                const product = products.find(p => p.product_id == productId); // Find the correct product

                if (!product) {
                    throw new Error(`Product with ID ${productId} not found`);
                }

                log('Found product:', product);
                return product;
            } catch (error) {
                console.error('Error fetching product:', error);
                showError('Could not load product details. Please try again later.');
                return null;
            } finally {
                hideLoading();
            }
        }
        
        // ========== RENDER PRODUCT PAGE ==========
        function renderBreadcrumb(product) {
            const breadcrumbHtml = `
                <ul class="pd-breadcrumb__list">
                    <li class="has-separator">
                        <a href="index.html">Home</a>
                    </li>
                    <li class="has-separator">
                        <a href="shop-side-version-2.html">${product.product_tree1 || 'Category'}</a>
                    </li>
                    ${product.product_tree2 ? `
                    <li class="has-separator">
                        <a href="shop-side-version-2.html">${product.product_tree2}</a>
                    </li>` : ''}
                    ${product.product_tree3 ? `
                    <li class="has-separator">
                        <a href="shop-side-version-2.html">${product.product_tree3}</a>
                    </li>` : ''}
                    <li class="is-marked">
                        <a href="#">${product.product_name}</a>
                    </li>
                </ul>
            `;
            productBreadcrumb.innerHTML = breadcrumbHtml;
        }
        
        // This one new function replaces the three old ones.
        function getFirstImageUrl(product) {
            const fallback = 'images/product/default.jpg';
            
            // The backend now provides a clean array, so we just check it.
            if (product && Array.isArray(product.product_imagePath) && product.product_imagePath.length > 0) {
                // The path is already a full S3 URL, so we return it directly.
                return product.product_imagePath[0];
            }
            
            // Fallback if no images are found.
            return fallback;
        }

        function renderGallery(product) {
            // 1) Get the image paths directly from the product object.
            // This is now a clean array of full S3 URLs.
            let imagePaths = (product && Array.isArray(product.product_imagePath)) 
                ? product.product_imagePath 
                : [];

            // Fallback logic for safety
            if (imagePaths.length === 0) {
                imagePaths.push(overrideImage || IMAGE_FALLBACK);
            }
            
            const mainUrl = imagePaths[0]; // The first image is the main one.

            // 3) Build the thumbnail HTML. No need to call 'urlify' anymore.
            let thumbsHtml = '';
            imagePaths.forEach((path, idx) => {
                // The 'path' is already a full URL.
                thumbsHtml += `<img src="${path}" data-idx="${idx}" class="${idx === 0 ? 'active' : ''}">`;
            });

            productGallery.innerHTML = `
                <div class="gallery-main">
                    <img id="gallery-main-image" class="u-img-fluid" src="${mainUrl}" alt="${product.product_name}">
                </div>
                <div class="gallery-thumbs">
                    ${thumbsHtml}
                </div>`;

            // 4) Interactivity remains the same.
            const mainImg = document.getElementById('gallery-main-image');
            productGallery.querySelectorAll('.gallery-thumbs img').forEach(img => {
                img.addEventListener('click', () => {
                    productGallery.querySelectorAll('.gallery-thumbs img').forEach(t => t.classList.remove('active'));
                    img.classList.add('active');
                    mainImg.src = img.src;
                });
            });
        }

        function renderProductDetails(product) {
            let optionsHtml = '';
            try {
                const options = JSON.parse(product.product_options || '{}');
                const optionKeys = Object.keys(options);

                if (optionKeys.length > 0) {
                    optionsHtml = optionKeys.map(key => {
                        const choices = options[key];
                        if (!Array.isArray(choices) || choices.length === 0) {
                            return ''; // Skip if choices are not a valid array
                        }

                        // Create a unique ID for the select element for the label
                        const selectId = `option-${key.replace(/\s+/g, '-').toLowerCase()}`;

                        const optionChoices = choices.map(choice =>
                            `<option value="${choice}">${choice}</option>`
                        ).join('');

                        return `
                            <div class="u-s-m-b-15">
                                <div class="pd-detail__label">${key}:</div>
                                <div class="pd-detail-form-group">
                                    <select class="select-box select-box--primary-style" id="${selectId}">
                                        ${optionChoices}
                                    </select>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (e) {
                console.error("Could not parse product_options JSON", e);
            }
            // Calculate price and discount
            const price = Number(product.product_price) || 0;
            const discountPct = Number(product.product_discount) || 0;
            const hasDiscount = discountPct > 0;
            const discountedPrice = hasDiscount ? price * (1 - discountPct / 100) : price;
            
            // Stock status
            const stock = Number(product.product_stock) || 0;
            const sold = Number(product.product_sale) || 0;
            const stockStatus = stock > 0 
                ? `<span class="pd-detail__stock">${sold} sold</span>`
                : `<span class="pd-detail__stock u-c-danger">Out of stock</span>`;
            
            const stockWarning = stock > 0 && stock <= 10 
                ? `<span class="pd-detail__left">Only ${stock} left</span>`
                : '';
            
            // Build HTML
            const detailsHtml = `
                <div>
                    <span class="pd-detail__name">${product.product_name || 'Product Name'}</span>
                </div>
                <div>
                    <div class="pd-detail__inline">
                        <span class="pd-detail__price">${formatPrice(discountedPrice)}</span>
                        ${hasDiscount ? `
                        <span class="pd-detail__discount">(${discountPct}% OFF)</span>
                        <del class="pd-detail__del">${formatPrice(price)}</del>
                        ` : ''}
                    </div>
                </div>
                <div class="u-s-m-b-15">
                    <div class="pd-detail__rating gl-rating-style">
                        ${(() => { const s = getReviewStats(product); return renderStars(s.avg); })()}
                        <span class="pd-detail__review u-s-m-l-4">
                            ${(() => { const s = getReviewStats(product); return `<a data-click-scroll="#view-review">${s.count} Review${s.count === 1 ? '' : 's'}</a>`; })()}
                        </span>
                    </div>
                </div>
                <div class="u-s-m-b-15">
                    <div class="pd-detail__inline">
                        ${stockStatus}
                        ${stockWarning}
                    </div>
                </div>

                <!-- ✅ NEW wishlist UI (clickable) -->
                <div class="u-s-m-b-15">
                  <div class="pd-detail__inline">
                    <span class="pd-detail__click-wrap">
                      <a id="pd-wishlist-btn" href="#" class="pd-wishlist-link" data-tooltip="tooltip" title="Add to Wishlist">
                        <i id="pd-wishlist-icon" class="far fa-heart u-s-m-r-6"></i>
                        <span id="pd-wishlist-text">Add to Wishlist</span>
                      </a>
                      <span class="pd-detail__click-count" id="pd-wishlist-count">(0)</span>
                    </span>
                  </div>
                </div>
                <!-- /wishlist UI -->

                <div class="u-s-m-b-15">
                    <span class="pd-detail__preview-desc">${product.product_description || 'No description available.'}</span>
                </div>

                    <form class="pd-detail__form">
                        <!-- Color Selection -->
                        ${optionsHtml}                        
                        <!-- Quantity and Add to Cart -->
                        <div class="pd-detail-inline-2">
                            <div class="u-s-m-b-15">
                                <div class="input-counter">
                                    <span class="input-counter__minus fas fa-minus"></span>
                                    <input class="input-counter__text input-counter--text-primary-style" type="text" value="1" data-min="1" data-max="1000">
                                    <span class="input-counter__plus fas fa-plus"></span>
                                </div>
                            </div>
                            <div class="u-s-m-b-15">
                                <button class="btn btn--e-brand-b-2" type="submit">Add to Cart</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="u-s-m-b-15">
                    <span class="pd-detail__label u-s-m-b-8">Product Policy:</span>
                    <ul class="pd-detail__policy-list">
                        <li><i class="fas fa-check-circle u-s-m-r-8"></i><span>Buyer Protection.</span></li>
                        <li><i class="fas fa-check-circle u-s-m-r-8"></i><span>Full Refund if you don't receive your order.</span></li>
                        <li><i class="fas fa-check-circle u-s-m-r-8"></i><span>Returns accepted if product not as described.</span></li>
                    </ul>
                </div>
            `;
            
            productDetails.innerHTML = detailsHtml;

            // Wire Add to Cart (unchanged)
            const form = productDetails.querySelector('.pd-detail__form');
            if (form) {
              form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn  = form.querySelector('button[type="submit"]');
                const qtyEl= form.querySelector('.input-counter__text');
                const qty  = qtyEl ? qtyEl.value : '1';
                if (btn) { btn.disabled = true; btn.textContent = 'Adding...'; }
                try {
                  const ok = await addToCart(product.product_id || new URLSearchParams(window.location.search).get('product_id'), qty);
                  if (ok) alert('Added to cart!');
                } catch (err) {
                  console.error(err);
                  alert('Could not add to cart.');
                } finally {
                  if (btn) { btn.disabled = false; btn.textContent = 'Add to Cart'; }
                }
              });
            }

            // ✅ Add this call at the END of renderProductDetails:
            wireWishlist(product);
        }
        
        function renderProductDescription(product) {
            // 1. --- NEW LOGIC: Dynamically build the specifications table ---
            let productInfoTableHtml = '';
            try {
                // Safely parse the product_table JSON string
                const specs = JSON.parse(product.product_table || '{}');
                const specKeys = Object.keys(specs);

                // Only build the table if there are specifications
                if (specKeys.length > 0) {
                    // Start building the table rows
                    const tableRows = specKeys.map(key => `
                        <tr>
                            <td>${key}</td>
                            <td>${specs[key]}</td>
                        </tr>
                    `).join('');

                    // Assemble the full table HTML
                    productInfoTableHtml = `
                        <div class="u-s-m-b-15">
                            <h4>PRODUCT INFORMATION</h4>
                        </div>
                        <div class="u-s-m-b-15">
                            <div class="pd-table gl-scroll">
                                <table>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error("Could not parse product specifications:", e);
                // If JSON is invalid, the table will simply not be rendered.
            }

            // 2. --- UPDATED RENDER: Use the dynamic table HTML ---
            const descriptionHtml = `
                <div class="u-s-m-b-15">
                    <p>${product.product_description || 'No detailed description available.'}</p>
                </div>
                <div class="u-s-m-b-30">
                    <ul>
                        <li><i class="fas fa-check u-s-m-r-8"></i><span>Buyer Protection.</span></li>
                        <li><i class="fas fa-check u-s-m-r-8"></i><span>Full Refund if you don't receive your order.</span></li>
                        <li><i class="fas fa-check u-s-m-r-8"></i><span>Returns accepted if product not as described.</span></li>
                    </ul>
                </div>

                ${productInfoTableHtml}
            `;
            
            productDescription.innerHTML = descriptionHtml;
        }
        
        async function renderProductReviews(product) {
            // Use helper to parse and summarize reviews
            const { list: reviews, count, avg } = getReviewStats(product);

            // Render existing reviews
            let reviewsListHtml = '';
            reviews.forEach(r => {
                reviewsListHtml += `
                    <div class="review-o u-s-m-b-15">
                        <div class="review-o__info u-s-m-b-8">
                            <span class="review-o__name">${r.user}</span>
                            <span class="review-o__date">${r.date}</span>
                        </div>
                        <div class="review-o__rating gl-rating-style u-s-m-b-8">
                            ${renderStars(Number(r.star) || 0)}
                            <span>(${r.star})</span>
                        </div>
                        <p class="review-o__text">${r.review}</p>
                    </div>
                `;
            });

            // Review summary and form
            const reviewsHtmlContent = `
                <div class="u-s-m-b-30">
                    <div class="pd-tab__rev-score">
                        <div class="u-s-m-b-8">
                            <h2>${count} Reviews - ${avg.toFixed(1)} (Overall)</h2>
                        </div>
                        <div class="gl-rating-style-2 u-s-m-b-8">
                            ${renderStars(avg)}
                        </div>
                        <div class="u-s-m-b-8">
                            <h4>We want to hear from you!</h4>
                        </div>
                        <span class="gl-text">Tell us what you think about this item</span>
                    </div>
                </div>
                <div class="u-s-m-b-30">
                    <div class="rev-f1__group">
                        <div class="u-s-m-b-15">
                            <h2 class="u-s-m-b-15">${count} Review(s) for ${product.product_name}</h2>
                        </div>
                    </div>
                    <div class="rev-f1__review">
                        ${reviewsListHtml || '<div>No reviews yet.</div>'}
                    </div>
                </div>
                <div class="u-s-m-b-30">
                    <div id="review-feedback" class="u-s-m-b-15" style="display:none;color:green;"></div>
                    <form class="pd-tab__rev-f2">
                        <h2 class="u-s-m-b-15">Add a Review</h2>
                        <span class="gl-text u-s-m-b-15">Your email address will not be published. Required fields are marked *</span>
                        <div class="u-s-m-b-15">
                            <label for="review-user">Name *</label>
                            <input class="input-text input-text--primary-style" id="review-user" name="user" type="text" required>
                        </div>
                        <div class="u-s-m-b-15">
                            <label for="review-star">Rating *</label>
                            <select class="select-box select-box--primary-style" id="review-star" name="star" required>
                                <option value="5">5 - Excellent</option>
                                <option value="4">4 - Good</option>
                                <option value="3">3 - Average</option>
                                <option value="2">2 - Poor</option>
                                <option value="1">1 - Terrible</option>
                            </select>
                        </div>
                        <div class="u-s-m-b-15">
                            <label for="review-text">Your Review *</label>
                            <textarea class="text-area text-area--primary-style" id="review-text" name="review" required></textarea>
                        </div>
                        <div class="u-s-m-b-15">
                            <button class="btn btn--e-brand-b-2" type="submit">Submit Review</button>
                        </div>
                    </form>
                </div>
            `;

            // Insert into container
            productReviews.innerHTML = reviewsHtmlContent;

            // Hook up review submission
            const reviewForm = document.querySelector('.pd-tab__rev-f2');
            if (reviewForm) {
                reviewForm.addEventListener('submit', async e => {
                    e.preventDefault();
                    const feedbackDiv = document.getElementById('review-feedback');
                    const submitBtn = reviewForm.querySelector('button[type="submit"]');
                    feedbackDiv.style.display = 'none';
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';
                    const formData = new FormData(reviewForm);
                    const newReview = {
                        user: formData.get('user') || 'Anonymous',
                        date: new Date().toLocaleDateString(),
                        star: formData.get('star') || '0',
                        review: formData.get('review') || ''
                    };
                    // Send to backend
                    const urlParams = new URLSearchParams(window.location.search);
                    const productId = urlParams.get('product_id');
                    const res = await fetch(`${PRODUCTS_API}/${productId}/reviews`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newReview)
                    });
                    if (res.ok) {
                        // Success feedback
                        feedbackDiv.innerText = 'Review submitted successfully!';
                        feedbackDiv.style.display = 'block';
                        // Reset form fields
                        reviewForm.reset();
                        // Update UI
                        reviews.push(newReview);
                        renderProductReviews({ ...product, product_reviews: JSON.stringify(reviews) });
                        renderProductDetails({ ...product, product_reviews: JSON.stringify(reviews) });
                    } else {
                        // Error feedback
                        feedbackDiv.innerText = 'Failed to submit review. Please try again.';
                        feedbackDiv.style.display = 'block';
                    }
                    // Restore button
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Review';
                });
            }
        }
        
        async function renderRelatedProducts() {
            try {
                const response = await fetch(PRODUCTS_API);
                if (!response.ok) throw new Error('Failed to fetch products');
                
                const products = await response.json();
                // Get 4 random products
                const randomProducts = [...products].sort(() => 0.5 - Math.random()).slice(0, 4);
                
                let productsHtml = '';
                randomProducts.forEach(product => {
                    // Calculate price and discount
                    const price = Number(product.product_price) || 0;
                    const discountPct = Number(product.product_discount) || 0;
                    const hasDiscount = discountPct > 0;
                    const discountedPrice = hasDiscount ? price * (1 - discountPct / 100) : price;

                    // Get image path (robust: JSON array or CSV from DB)
                    const imagePath = getFirstImageUrl(product)

                    // Get real review stats
                    const { avg, count } = getReviewStats(product);

                    // Use product.rowid for links, as requested
                    productsHtml += `
                        <div class="col-lg-3 col-md-4 col-sm-6 u-s-m-b-30">
                            <div class="product-o product-o--hover-on">
                                <div class="product-o__wrap">
                                    <a class="aspect aspect--bg-grey aspect--square u-d-block" href="product-detail-variable.html?product_id=${product.product_id}&image=${encodeURIComponent(imagePath)}">
                                        <img class="aspect__img" src="${imagePath}" alt="${product.product_name}">
                                    </a>
                                    <div class="product-o__action-wrap">
                                        <ul class="product-o__action-list">
                                            <li>
                                                <a data-modal="modal" data-modal-id="#quick-look" data-tooltip="tooltip" data-placement="top" title="Quick View">
                                                    <i class="fas fa-search-plus"></i>
                                                </a>
                                            </li>
                                            <li>
                                                <a data-modal="modal" data-modal-id="#add-to-cart" data-tooltip="tooltip" data-placement="top" title="Add to Cart">
                                                    <i class="fas fa-plus-circle"></i>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="signin.html" data-tooltip="tooltip" data-placement="top" title="Add to Wishlist">
                                                    <i class="fas fa-heart"></i>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="signin.html" data-tooltip="tooltip" data-placement="top" title="Email me When the price drops">
                                                    <i class="fas fa-envelope"></i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <span class="product-o__category">
                                    <a href="shop-side-version-2.html">${product.product_tree1 || 'Category'}</a>
                                </span>
                                <span class="product-o__name">
                                    <a href="product-detail-variable.html?product_id=${product.product_id}&image=${encodeURIComponent(imagePath)}">${product.product_name || 'Product Name'}</a>
                                </span>
                                <div class="product-o__rating gl-rating-style">
                                    ${renderStars(avg)}
                                    <span class="product-o__review">(${count})</span>
                                </div>
                                <span class="product-o__price">
                                    ${formatPrice(discountedPrice)}
                                    ${hasDiscount ? `<span class="product-o__discount">${formatPrice(price)}</span>` : ''}
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                relatedProducts.innerHTML = productsHtml;
            } catch (error) {
                console.error('Error fetching related products:', error);
                relatedProducts.innerHTML = '<p>Could not load related products</p>';
            }
        }
        
        // ========== INITIALIZATION ==========
        async function initProductPage() {
            // Get product ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('product_id');
            
            if (!productId) {
                showError('Product ID not specified in URL');
                return;
            }
            
            // Fetch product data
            const product = await fetchProductData(productId);
            
            if (!product) {
                showError('Product not found');
                return;
            }
            
            // Update page title
            document.title = `${product.product_name} - Ludus`;
            
            // Render all product sections
            renderBreadcrumb(product);
            renderGallery(product);
            renderProductDetails(product);
            renderProductDescription(product);
            renderProductReviews(product);
            await renderRelatedProducts();

            // Hide the initial preloader overlay
            const preloader = document.querySelector('.preloader');
            if (preloader) {
                preloader.classList.remove('is-active');
            }

            // Update the preloader image element to show the main product image
            const preloaderImg = document.querySelector('.preloader__img');
            if (preloaderImg) {
                const mainImageUrl = overrideImage
                  ? overrideImage
                  : firstImageUrlFromField(product.product_imagePath);
                preloaderImg.src = mainImageUrl;
                // Also set the main-page-image src
                const mainPageImage = document.getElementById('main-page-image');
                if (mainPageImage) {
                    mainPageImage.src = mainImageUrl;
                }
            }
        }
        
        // Start the process
        document.addEventListener('DOMContentLoaded', initProductPage);
        
    })();
    </script>
</body>
</html>