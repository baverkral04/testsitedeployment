<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="UTF-8">
    <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="images/favicon.png" rel="shortcut icon">
    <title>Ludus - Electronics, Apparel, Computers, Books, DVDs & more</title>

    <!--====== Google Font ======-->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet">

    <!--====== Vendor Css ======-->
    <link rel="stylesheet" href="css/vendor.css">

    <!--====== Utility-Spacing ======-->
    <link rel="stylesheet" href="css/utility.css">

    <!--====== App ======-->
    <link rel="stylesheet" href="css/app.css">
    <script src="user.js"></script>

</head>
<body class="config">
    <div class="preloader is-active">
        <div class="preloader__wrap">

            <img class="preloader__img" src="images/preloader.png" alt=""></div>
    </div>

    <!--====== Main App ======-->
    <div id="app">

        <!--====== Main Header ======-->
       <div id="header-placeholder"></div>
        <script>
        (async () => {
        const el = document.getElementById('header-placeholder');
        const resp = await fetch('top_bar.html?_=' + Date.now()); // bust cache
        const html = await resp.text();
        el.innerHTML = html;

        document.dispatchEvent(new CustomEvent('user:changed'));

        // Execute any <script> tags inside the injected HTML
        el.querySelectorAll('script').forEach((old) => {
            const s = document.createElement('script');
            if (old.src) {
            s.src = old.src; s.async = old.async; s.defer = old.defer || false;
            } else {
            s.textContent = old.textContent;
            }
            document.head.appendChild(s);
        });

        // Call menu builder with already-fetched products if we have them
        const tryInit = () => {
            if (typeof window.initHeaderMenu === 'function') {
            window.initHeaderMenu(window.__ALL_PRODUCTS__ || null);
            }
        };
        // tiny delay to ensure the function is defined
        setTimeout(tryInit, 0);
        })();
        </script>
        <!--====== End - Main Header ======-->


        <!--====== App Content ======-->
        <div class="app-content">

            <!--====== Section 1 ======-->
            <div class="u-s-p-y-60">

                <!--====== Section Content ======-->
                <div class="section__content">
                    <div class="container">
                        <div class="breadcrumb">
                            <div class="breadcrumb__wrap">
                                <ul class="breadcrumb__list">
                                    <li class="has-separator">

                                        <a href="index.html">Home</a></li>
                                    <li class="is-marked">

                                        <a href="dashboard.html">My Account</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--====== End - Section 1 ======-->


            <!--====== Section 2 ======-->
            <div class="u-s-p-b-60">

                <!--====== Section Content ======-->
                <div class="section__content">
                    <div class="dash">
                        <div class="container">
                            <div class="row">
                                <div class="col-lg-3 col-md-12">

                                    <!--====== Dashboard Features ======-->
                                    <div class="dash__box dash__box--bg-white dash__box--shadow u-s-m-b-30">
                                        <div class="dash__pad-1">

                                            <span class="dash__text u-s-m-b-16" data-user-hello>Hello, John Doe</span>
                                            <ul class="dash__f-list">
                                                <li>

                                                    <a class="dash-active" href="dashboard.html">Manage My Account</a></li>
                                                <li>

                                                    <a href="dash-my-profile.html">My Profile</a></li>

                                                <li>

                                                    <a href="dash-track-order.html">Track Order</a></li>
    

                                                <li>

                                                    <a href="dash-cancellation.html">My Returns & Cancellations</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="dash__box dash__box--bg-white dash__box--shadow dash__box--w">
                                        <div class="dash__pad-1">
                                            <ul class="dash__w-list">
                                                <li>
                                                    <div class="dash__w-wrap">

                                                        <span class="dash__w-icon dash__w-icon-style-1"><i class="fas fa-cart-arrow-down"></i></span>

                                                        <span class="dash__w-text">4</span>

                                                        <span class="dash__w-name">Orders Placed</span></div>
                                                </li>
                                                <li>
                                                    <div class="dash__w-wrap">

                                                        <span class="dash__w-icon dash__w-icon-style-2"><i class="fas fa-times"></i></span>

                                                        <span class="dash__w-text">0</span>

                                                        <span class="dash__w-name">Cancel Orders</span></div>
                                                </li>
                                                <li>
                                                    <div class="dash__w-wrap">

                                                        <span class="dash__w-icon dash__w-icon-style-3"><i class="far fa-heart"></i></span>

                                                        <span class="dash__w-text">0</span>

                                                        <span class="dash__w-name">Wishlist</span></div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <!--====== End - Dashboard Features ======-->
                                </div>
                                <div class="col-lg-9 col-md-12">
                                    <div class="dash__box dash__box--shadow dash__box--radius dash__box--bg-white u-s-m-b-30">
                                        <div class="dash__pad-2">
                                            <h1 class="dash__h1 u-s-m-b-14">Manage My Account</h1>

                                            <span class="dash__text u-s-m-b-30">From your My Account Dashboard you have the ability to view a snapshot of your recent account activity and update your account information. Select a link below to view or edit information.</span>
                                            <div class="row">
                                                <div class="col-lg-4 u-s-m-b-30">
                                                    <div class="dash__box dash__box--bg-grey dash__box--shadow-2 u-h-100">
                                                        <div class="dash__pad-3">
                                                            <h2 class="dash__h2 u-s-m-b-8">PERSONAL PROFILE</h2>
                                                            <div class="dash__link dash__link--secondary u-s-m-b-8">

                                                                <a href="dash-edit-profile.html">Edit</a></div>

                                                            <span class="dash__text" data-user-name>—</span>

                                                            <span class="dash__text" data-user-email>—</span>
                                                            <div class="dash__link dash__link--secondary u-s-m-t-8">

                                                                <a data-modal="modal" data-modal-id="#dash-newsletter">Subscribe Newsletter</a></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-4 u-s-m-b-30">
                                                    <div class="dash__box dash__box--bg-grey dash__box--shadow-2 u-h-100">
                                                        <div class="dash__pad-3">
                                                            <h2 class="dash__h2 u-s-m-b-8">ADDRESS BOOK</h2>

                                                            <span class="dash__text-2 u-s-m-b-8">Default Shipping Address</span>
                                                            <div class="dash__link dash__link--secondary u-s-m-b-8">
                                                                <a data-modal="modal" data-modal-id="#dash-address-edit">Edit</a>
                                                            </div>

                                                            <span class="dash__text" data-user-address>—</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-4 u-s-m-b-30">
                                                    <div class="dash__box dash__box--bg-grey dash__box--shadow-2 u-h-100">
                                                        <div class="dash__pad-3">
                                                            <h2 class="dash__h2 u-s-m-b-8">BILLING ADDRESS</h2>

                                                            <span class="dash__text-2 u-s-m-b-8">Default Billing Address</span>
                                                            <div class="dash__link dash__link--secondary u-s-m-b-8">
                                                                <a data-modal="modal" data-modal-id="#dash-billing-edit">Edit</a>
                                                            </div>

                                                            <span class="dash__text" data-user-billing-address>—</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dash__box dash__box--shadow dash__box--bg-white dash__box--radius">
                                        <h2 class="dash__h2 u-s-p-xy-20">RECENT ORDERS</h2>
                                        <div class="dash__table-wrap gl-scroll">
                                            <table class="dash__table">
                                                <thead>
                                                    <tr>
                                                        <th>Order #</th>
                                                        <th>Placed On</th>
                                                        <th>Items</th>
                                                        <th>Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="recent-orders-body">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--====== End - Section Content ======-->
            </div>
            <!--====== End - Section 2 ======-->
        </div>
        <!--====== End - App Content ======-->


        <!--====== Main Footer ======-->
        <div id="footer-placeholder"></div>
        <script>
        (async () => {
            const el = document.getElementById('footer-placeholder');
            const resp = await fetch('footer.html?_=' + Date.now()); // Fetch footer.html
            const html = await resp.text();
            el.innerHTML = html;
        })();
        </script>
        </div>

        <!--====== Modal Section ======-->


        <!--====== Unsubscribe or Subscribe Newsletter ======-->
        <div class="modal fade" id="dash-newsletter">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content modal--shadow">
                    <div class="modal-body">
                        <form class="d-modal__form">
                            <div class="u-s-m-b-15">
                                <h1 class="gl-modal-h1">Newsletter Subscription</h1>

                                <span class="gl-modal-text">I have read and understood</span>

                                <a class="d_modal__link" href="dashboard.html">Ludus Privacy Policy</a>
                            </div>
                            <div class="gl-modal-btn-group">

                                <button class="btn btn--e-brand-b-2" type="submit">SUBSCRIBE</button>

                                <button class="btn btn--e-grey-b-2" type="button" data-dismiss="modal">CANCEL</button></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!--====== Unsubscribe or Subscribe Newsletter ======-->

        <!--====== Edit Address Modal ======-->
        <div class="modal fade" id="dash-address-edit">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal--shadow">
              <div class="modal-body">
                <form id="address-form" class="d-modal__form">
                  <div class="u-s-m-b-15">
                    <h1 class="gl-modal-h1">Edit Address</h1>
                    <span class="gl-modal-text">Enter your US mailing address</span>
                  </div>
                  <div class="u-s-m-b-15">
                    <label class="gl-label" for="addr-line1">Street address</label>
                    <input class="input-text input-text--primary-style" id="addr-line1" type="text" required placeholder="123 Main St">
                  </div>
                  <div class="u-s-m-b-15">
                    <label class="gl-label" for="addr-line2">Apt, suite, etc. (optional)</label>
                    <input class="input-text input-text--primary-style" id="addr-line2" type="text" placeholder="Apt 4B">
                  </div>
                  <div class="u-s-m-b-15">
                    <label class="gl-label" for="addr-city">City</label>
                    <input class="input-text input-text--primary-style" id="addr-city" type="text" required placeholder="Austin">
                  </div>
                  <div class="u-s-m-b-15">
                    <label class="gl-label" for="addr-state">State (2-letter)</label>
                    <input class="input-text input-text--primary-style" id="addr-state" type="text" required maxlength="2" pattern="[A-Za-z]{2}" placeholder="TX">
                  </div>
                  <div class="u-s-m-b-15">
                    <label class="gl-label" for="addr-zip">ZIP code</label>
                    <input class="input-text input-text--primary-style" id="addr-zip" type="text" required pattern="\d{5}(-\d{4})?" placeholder="78701">
                  </div>
                  <div class="gl-modal-btn-group">
                    <button class="btn btn--e-brand-b-2" type="submit">SAVE</button>
                    <button class="btn btn--e-grey-b-2" type="button" data-dismiss="modal">CANCEL</button>
                  </div>
                  <div id="addr-msg" class="gl-text u-s-m-t-10" aria-live="polite"></div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <!--====== End - Edit Address Modal ======-->
        <!--====== Edit Billing Address Modal ======-->
        <div class="modal fade" id="dash-billing-edit">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal--shadow">
              <div class="modal-body">
                <form id="billing-form" class="d-modal__form">
                  <div class="u-s-m-b-15">
                    <h1 class="gl-modal-h1">Edit Billing Address</h1>
                    <span class="gl-modal-text">Enter your US billing address</span>
                  </div>
                  <div class="u-s-m-b-15">
                    <label class="gl-label" for="bill-line1">Street address</label>
                    <input class="input-text input-text--primary-style" id="bill-line1" type="text" required placeholder="123 Main St">
                  </div>
                  <div class="u-s-m-b-15">
                    <label class="gl-label" for="bill-line2">Apt, suite, etc. (optional)</label>
                    <input class="input-text input-text--primary-style" id="bill-line2" type="text" placeholder="Apt 4B">
                  </div>
                  <div class="u-s-m-b-15">
                    <label class="gl-label" for="bill-city">City</label>
                    <input class="input-text input-text--primary-style" id="bill-city" type="text" required placeholder="Austin">
                  </div>
                  <div class="u-s-m-b-15">
                    <label class="gl-label" for="bill-state">State (2-letter)</label>
                    <input class="input-text input-text--primary-style" id="bill-state" type="text" required maxlength="2" pattern="[A-Za-z]{2}" placeholder="TX">
                  </div>
                  <div class="u-s-m-b-15">
                    <label class="gl-label" for="bill-zip">ZIP code</label>
                    <input class="input-text input-text--primary-style" id="bill-zip" type="text" required pattern="\d{5}(-\d{4})?" placeholder="78701">
                  </div>
                  <div class="gl-modal-btn-group">
                    <button class="btn btn--e-brand-b-2" type="submit">SAVE</button>
                    <button class="btn btn--e-grey-b-2" type="button" data-dismiss="modal">CANCEL</button>
                  </div>
                  <div id="bill-msg" class="gl-text u-s-m-t-10" aria-live="polite"></div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <!--====== End - Edit Billing Address Modal ======-->
        <!--====== End - Modal Section ======-->
    </div>
    <!--====== End - Main App ======-->


    <!--====== Google Analytics: change UA-XXXXX-Y to be your site's ID ======-->
    <script>
        window.ga = function() {
            ga.q.push(arguments)
        };
        ga.q = [];
        ga.l = +new Date;
        ga('create', 'UA-XXXXX-Y', 'auto');
        ga('send', 'pageview')
    </script>
    <script src="https://www.google-analytics.com/analytics.js" async defer></script>

    <!--====== Vendor Js ======-->
    <script src="js/vendor.js"></script>

    <!--====== jQuery Shopnav plugin ======-->
    <script src="js/jquery.shopnav.js"></script>

    <!--====== User State (make sure the path is correct for your project) ======-->

    <script>
    (function(){
      function fillProfileBox(){
        try {
          var user = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
          var name = user && (user.user_name || user.user_email) || '';
          var email = user && user.user_email || '';
          var helloEl = document.querySelector('[data-user-hello]');
          var nameEl  = document.querySelector('[data-user-name]');
          var emailEl = document.querySelector('[data-user-email]');
          if (helloEl) helloEl.textContent = name ? ('Hello, ' + name) : 'Hello';
          if (nameEl)  nameEl.textContent  = name  || '—';
          if (emailEl) emailEl.textContent = email || '—';
        } catch (_) {}
      }
      document.addEventListener('user:changed', fillProfileBox);
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fillProfileBox);
      } else {
        fillProfileBox();
      }
    })();
    </script>

    <script>
    (function(){

      var SHIP_UPDATE_URL = `${API_ROOT}/users/update-address`;
      var BILL_UPDATE_URL = `${API_ROOT}/users/update-billing-address`;


      function getUserSafe(){ try { return (typeof getCurrentUser === 'function') ? getCurrentUser() : null; } catch(e){ return null; } }

      function addressToString(p){
        var cityState = [p.city, p.state].filter(Boolean).join(', ');
        return [p.line1, p.line2, cityState, p.zip, 'USA'].filter(Boolean).join(', ');
      }

      // --- Shipping (Default Address Book) ---
      function fillAddressFromCurrentUser(){
        var user = getUserSafe();
        var addr = (user && user.user_Address) || '';
        var el = document.querySelector('[data-user-address]');
        if (el) el.textContent = (addr && addr.trim()) ? addr : '—';
      }

      async function saveAddress(p){
        var user = getUserSafe();
        if (!user) throw new Error('Not signed in');
        var addrStr = addressToString(p);
        var payload = { user_address: addrStr, user_id: user.user_id, user_email: user.user_email };
        var res = await fetch(SHIP_UPDATE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!res.ok) throw new Error(String(res.status));
        user.user_Address = addrStr; // optimistic
        if (typeof setCurrentUser === 'function') setCurrentUser(user);
        return res.json().catch(()=>({}));
      }

      function wireAddressModal(){
        var form = document.getElementById('address-form');
        if (!form) return;
        form.addEventListener('submit', async function(e){
          e.preventDefault();
          var msg = document.getElementById('addr-msg');
          var p = {
            line1: document.getElementById('addr-line1').value.trim(),
            line2: document.getElementById('addr-line2').value.trim(),
            city:  document.getElementById('addr-city').value.trim(),
            state: document.getElementById('addr-state').value.trim().toUpperCase(),
            zip:   document.getElementById('addr-zip').value.trim()
          };
          if (msg) { msg.textContent = 'Saving...'; msg.style.color=''; }
          try {
            await saveAddress(p);
            fillAddressFromCurrentUser();
            if (msg) { msg.textContent = 'Saved.'; msg.style.color='green'; }
            var closeBtn = form.querySelector('[data-dismiss="modal"]'); if (closeBtn) closeBtn.click();
          } catch (err) {
            if (msg) { msg.textContent = 'Failed to save address'; msg.style.color='red'; }
            console.error('[address] save failed', err);
          }
        });
      }

      // --- Billing Address ---
      function fillBillingFromCurrentUser(){
        var user = getUserSafe();
        var addr = (user && user.user_BillingAddress) || '';
        var el = document.querySelector('[data-user-billing-address]');
        if (el) el.textContent = (addr && addr.trim()) ? addr : '—';
      }

      async function saveBillingAddress(p){
        var user = getUserSafe();
        if (!user) throw new Error('Not signed in');
        var addrStr = addressToString(p);
        var payload = { user_BillingAddress: addrStr, user_id: user.user_id, user_email: user.user_email };
        var res = await fetch(BILL_UPDATE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!res.ok) throw new Error(String(res.status));
        user.user_BillingAddress = addrStr; // optimistic
        if (typeof setCurrentUser === 'function') setCurrentUser(user);
        return res.json().catch(()=>({}));
      }

      function wireBillingModal(){
        var form = document.getElementById('billing-form');
        if (!form) return;
        form.addEventListener('submit', async function(e){
          e.preventDefault();
          var msg = document.getElementById('bill-msg');
          var p = {
            line1: document.getElementById('bill-line1').value.trim(),
            line2: document.getElementById('bill-line2').value.trim(),
            city:  document.getElementById('bill-city').value.trim(),
            state: document.getElementById('bill-state').value.trim().toUpperCase(),
            zip:   document.getElementById('bill-zip').value.trim()
          };
          if (msg) { msg.textContent = 'Saving...'; msg.style.color=''; }
          try {
            await saveBillingAddress(p);
            fillBillingFromCurrentUser();
            if (msg) { msg.textContent = 'Saved.'; msg.style.color='green'; }
            var closeBtn = form.querySelector('[data-dismiss="modal"]'); if (closeBtn) closeBtn.click();
          } catch (err) {
            if (msg) { msg.textContent = 'Failed to save billing address'; msg.style.color='red'; }
            console.error('[billing] save failed', err);
          }
        });
      }

      // Init
      document.addEventListener('DOMContentLoaded', function(){
        fillAddressFromCurrentUser();
        wireAddressModal();
        fillBillingFromCurrentUser();
        wireBillingModal();
      });
      document.addEventListener('user:changed', function(){
        fillAddressFromCurrentUser();
        fillBillingFromCurrentUser();
      });
    })();
    </script>

    <script>
    (function(){
      const DEBUG = true;
      const log = (...a)=>DEBUG&&console.log('[RECENT-ORDERS]',...a);
      
      // CHANGED: Use the correct, existing endpoint for all orders
      const ORDERS_API = `${API_ROOT}/orders`;

      function getUserSafe(){ try { return (typeof getCurrentUser === 'function') ? getCurrentUser() : null; } catch(e){ return null; } }

      async function fetchAndFilterOrders() {
        const currentUser = getUserSafe();
        if (!currentUser) return [];

        try {
          const response = await fetch(ORDERS_API);
          if (!response.ok) return [];
          
          const allOrders = await response.json();
          
          // Filter orders to only include those matching the current user's email or ID
          const userOrders = allOrders.filter(order => {
            try {
              const orderUser = JSON.parse(order.order_user);
              const hasUserId = currentUser.user_id && (orderUser.user_id == currentUser.user_id);
              const hasUserEmail = currentUser.user_email && (orderUser.user_email == currentUser.user_email);
              return hasUserId || hasUserEmail;
            } catch (e) { return false; }
          });
          return userOrders;
        } catch (error) {
          log('fetch error', error);
          return [];
        }
      }

      function money(n){ return Number(n||0).toLocaleString('en-US', { style:'currency', currency:'USD' }); }
      function dateStr(s){
        if (!s) return '—';
        try { const d = new Date(s); if (!isNaN(d)) return d.toLocaleDateString(); } catch {}
        return String(s);
      }
      function esc(s){ return String(s==null?'':s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

      function rowHTML(order){
        let items, total;
        try {
            items = JSON.parse(order.order_product);
            total = items.reduce((sum, item) => sum + parseFloat(item.product_total || 0), 0);
        } catch {
            items = [];
            total = 0;
        }
        
        return (
          '<tr>'+
            '<td><a href="dash-track-order.html">'+esc(order.order_id)+'</a></td>'+
            '<td>'+esc(new Date().toLocaleDateString())+'</td>'+ // Note: Your order object does not have a date, using today's date
            '<td>'+esc(items.length)+'</td>'+
            '<td>'+
              '<div class="dash__table-total">'+
                '<span>'+money(total)+'</span>'+
              '</div>'+
            '</td>'+
          '</tr>'
        );
      }

      async function renderOrders(){
        const tbody = document.getElementById('recent-orders-body');
        if (!tbody) return;
        tbody.innerHTML = '<tr class="js-orders-placeholder"><td colspan="4">Loading orders...</td></tr>';

        const list = await fetchAndFilterOrders();

        if (!list.length) {
          tbody.innerHTML = '<tr><td colspan="4" class="u-s-p-xy-20">You have no past orders.</td></tr>';
          return;
        }
        
        // Sort by most recent first (we'll use order_id as a proxy since there's no date)
        list.sort((a,b) => String(b.order_id).localeCompare(String(a.order_id)));

        tbody.innerHTML = list.slice(0, 5).map(rowHTML).join(''); // Show latest 5
      }

      document.addEventListener('DOMContentLoaded', renderOrders);
      document.addEventListener('user:changed', renderOrders);
    })();
    </script>
    <!--====== App ======-->
    <script src="js/app.js"></script>

    <!--====== Noscript ======-->
    <noscript>
        <div class="app-setting">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="app-setting__wrap">
                            <h1 class="app-setting__h1">JavaScript is disabled in your browser.</h1>

                            <span class="app-setting__text">Please enable JavaScript in your browser or upgrade to a JavaScript-capable browser.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </noscript>
</body>
</html>