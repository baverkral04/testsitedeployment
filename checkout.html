<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Checkout</title>
    <link rel="stylesheet" href="css/vendor.css">
    <link rel="stylesheet" href="css/utility.css">
    <link rel="stylesheet" href="css/app.css">
    <script src="user.js"></script>
</head>
<body class="config">
    
    <div id="app">
       <div id="header-placeholder"></div>
        <script>
        (async () => {
        const el = document.getElementById('header-placeholder');
        const resp = await fetch('top_bar.html?_=' + Date.now()); // bust cache
        const html = await resp.text();
        el.innerHTML = html;

        // Execute any <script> tags inside the injected HTML

        document.dispatchEvent(new CustomEvent('user:changed'));
    
        el.querySelectorAll('script').forEach((old) => {
            const s = document.createElement('script');
            if (old.src) {
            s.src = old.src; s.async = old.async; s.defer = old.defer || false;
            } else {
            s.textContent = old.textContent;
            }
            document.head.appendChild(s);
        });

        // Call menu builder with already-fetched products if we have them
        const tryInit = () => {
            if (typeof window.initHeaderMenu === 'function') {
            window.initHeaderMenu(window.__ALL_PRODUCTS__ || null);
            }
        };
        // tiny delay to ensure the function is defined
        setTimeout(tryInit, 0);
        })();
        </script>

        <div class="app-content">
            <div class="u-s-p-y-60">
                <div class="section__content">
                    <div class="container">
                        <div class="breadcrumb">
                            <div class="breadcrumb__wrap">
                                <ul class="breadcrumb__list">
                                    <li class="has-separator"><a href="index.html">Home</a></li>
                                    <li class="is-marked"><a href="checkout.html">Checkout</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="u-s-p-b-60">
                <div class="section__content">
                    <div class="container">
                        <div class="checkout-f">
                            <div class="row">
                                <div class="col-lg-6">
                                    <h1 class="checkout-f__h1">DELIVERY INFORMATION</h1>
                                        <form id="shipping-form" class="checkout-f__delivery">
                                        <div class="u-s-m-b-15">
                                            <label class="gl-label" for="ship-line1">Street address *</label>
                                            <input class="input-text input-text--primary-style" id="ship-line1" type="text" required placeholder="123 Main St">
                                        </div>
                                        <div class="u-s-m-b-15">
                                            <label class="gl-label" for="ship-line2">Apt, suite, etc. (optional)</label>
                                            <input class="input-text input-text--primary-style" id="ship-line2" type="text" placeholder="Apt 4B">
                                        </div>
                                        <div class="u-s-m-b-15">
                                            <label class="gl-label" for="ship-city">City *</label>
                                            <input class="input-text input-text--primary-style" id="ship-city" type="text" required placeholder="Austin">
                                        </div>
                                        <div class="u-s-m-b-15">
                                            <label class="gl-label" for="ship-state">State (2-letter) *</label>
                                            <input class="input-text input-text--primary-style" id="ship-state" type="text" maxlength="2" pattern="[A-Za-z]{2}" required placeholder="TX">
                                        </div>
                                        <div class="u-s-m-b-15">
                                            <label class="gl-label" for="ship-zip">ZIP code *</label>
                                            <input class="input-text input-text--primary-style" id="ship-zip" type="text" pattern="\d{5}(-\d{4})?" required placeholder="78701">
                                        </div>
                                        <input id="ship-country" type="hidden" value="US">
                                        <div id="shipping-msg" class="form-message u-s-m-t-10"></div>
                                        </form>
                                </div>
                                <div class="col-lg-6">
                                    <h1 class="checkout-f__h1">ORDER SUMMARY</h1>
                                    <div class="o-summary">
                                        <div class="o-summary__section u-s-m-b-30">
                                            <div class="o-summary__item-wrap gl-scroll" id="cart-item-container">
                                                <p>Loading cart...</p>
                                            </div>
                                        </div>
                                        <div class="o-summary__section u-s-m-b-30">
                                            <div class="o-summary__box">
                                                <table class="o-summary__table">
                                                    <tbody id="cart-totals-container">
                                                        </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="o-summary__section u-s-m-b-30">
                                            <div class="o-summary__box">
                                                <h1 class="checkout-f__h1">PAYMENT</h1>
                                                <form id="checkout-form" class="checkout-f__payment">
                                                    <p class="u-s-m-b-15">Click the button below to proceed to our secure payment partner, Stripe. Your order details will be finalized there.</p>
                                                    <button class="btn btn--e-brand-b-2" id="checkout-btn" type="submit">Proceed to Secure Payment</button>
                                                    <div id="checkout-msg" class="form-message u-s-m-t-15"></div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-placeholder"></div>
        <script>
        (async () => {
            const el = document.getElementById('footer-placeholder');
            const resp = await fetch('footer.html?_=' + Date.now()); // Fetch footer.html
            const html = await resp.text();
            el.innerHTML = html;
        })();
        </script>
    </div>

    <script src="js/vendor.js"></script>
    <script src="js/jquery.shopnav.js"></script>
    <script src="js/app.js"></script>

    <script>
        // Load Header & Footer

        // Load Footer
        (async () => {
            const el = document.getElementById('footer-placeholder');
            const resp = await fetch('footer.html?_=' + Date.now());
            const html = await resp.text();
            el.innerHTML = html;
        })();

        // Checkout helpers
        const SHIPPING_UPDATE_URL = `${window.API_ROOT}/users/update-address`;

        function buildAddressString({ line1, line2, city, state, zip, country }) {
            const street = [line1.trim(), line2.trim()].filter(Boolean).join(' ').trim();
            const parts = [street, city.trim(), state.trim().toUpperCase(), zip.trim()];
            if (country) parts.push(country.trim());
            return parts.filter(Boolean).join(', ');
        }

        function parseAddressString(value) {
            const parts = (value || '').split(',').map(p => p.trim()).filter(Boolean);
            return {
                line1: parts[0] || '',
                city: parts[1] || '',
                state: parts[2] || '',
                zip: parts[3] || '',
                country: parts[4] || 'US'
            };
        }

        async function saveShippingAddress(address, user) {
            const res = await fetch(SHIPPING_UPDATE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ user_id: user.user_id, user_email: user.user_email, user_address: address })
            });
            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                throw new Error(error.error || 'Failed to save address');
            }
            const updatedUser = await res.json();
            window.setCurrentUser?.(updatedUser, true);
            return updatedUser;
        }

        function hydrateShippingForm(user) {
            if (!user || !user.user_Address) return;
            const parsed = parseAddressString(user.user_Address);
            const line1 = document.getElementById('ship-line1');
            const line2 = document.getElementById('ship-line2');
            const city = document.getElementById('ship-city');
            const state = document.getElementById('ship-state');
            const zip = document.getElementById('ship-zip');
            const country = document.getElementById('ship-country');
            if (line1) line1.value = parsed.line1;
            if (line2) line2.value = parsed.line2 || '';
            if (city) city.value = parsed.city;
            if (state) state.value = parsed.state;
            if (zip) zip.value = parsed.zip;
            if (country) country.value = parsed.country || 'US';
        }

        function getImageUrl(product) {
            const IMAGE_FALLBACK = '';
            try {
                let primaryPath = '';
                // The 'pick' function is not defined here, so we'll access the property directly
                const v = product.product_imagePath;

                if (v) {
                    // This handles both new arrays and old JSON strings gracefully
                    const pathArray = Array.isArray(v) ? v : JSON.parse(v);
                    if (Array.isArray(pathArray) && pathArray.length > 0) {
                        primaryPath = pathArray[0];
                    }
                }
            
                if (primaryPath) {
                    // If it's a full S3 URL, use it directly. Otherwise, build the path.
                    return primaryPath.startsWith('http') ? primaryPath : `${window.API_HOST}/${primaryPath.replace(/^\/+/, '')}`;
                }
            } catch (e) {
                console.warn('Could not parse image path for product:', product.product_id);
            }
                return IMAGE_FALLBACK; // Return empty string if anything fails
        }

    
        (async () => {
            await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));

            if (typeof window.checkSession === 'function') {
                await window.checkSession();
            }

            const itemContainer = document.getElementById('cart-item-container');
            const totalsContainer = document.getElementById('cart-totals-container');
            const checkoutBtn = document.getElementById('checkout-btn');
            const checkoutMsg = document.getElementById('checkout-msg');
            const shippingMsg = document.getElementById('shipping-msg');

            let currentUser = window.getCurrentUser?.();
            if (!currentUser) {
                window.location.href = 'signin.html';
                return;
            }

            hydrateShippingForm(currentUser);

            let userCart = [];
            if (Array.isArray(currentUser.user_cart)) {
                userCart = currentUser.user_cart.slice();
            } else if (typeof currentUser.user_cart === 'string' && currentUser.user_cart.trim()) {
                try {
                    userCart = JSON.parse(currentUser.user_cart);
                } catch (err) {
                    console.warn('Could not parse user_cart JSON in checkout:', err);
                    userCart = [];
                }
            }

            const productsRes = await fetch(`${window.API_ROOT}/products`);
            if (!productsRes.ok) throw new Error('Could not load products for checkout');
            const productsMap = new Map((await productsRes.json()).map(p => [String(p.product_id), p]));

            if (userCart.length) {
                let itemsHtml = '';
                let subtotal = 0;

                for (const item of userCart) {
                    const product = productsMap.get(String(item.product_id));
                    if (!product) continue;

                    const price = parseFloat(product.product_price) || 0;
                    const discount = parseFloat(product.product_discount) || 0;
                    const finalPrice = price * (1 - discount / 100);
                    subtotal += finalPrice * (parseInt(item.product_amount, 10) || 0);

                    itemsHtml += `
                        <div class="o-card">
                        <div class="o-card__flex">
                            <div class="o-card__img-wrap">
                            <img class="u-img-fluid" src="${getImageUrl(product)}" alt="">
                            </div>
                            <div class="o-card__info-wrap">
                            <span class="o-card__name"><a href="#">${product.product_name}</a></span>
                            <span class="o-card__quantity">Quantity x ${item.product_amount}</span>
                            <span class="o-card__price">$${finalPrice.toFixed(2)}</span>
                            </div>
                        </div>
                        </div>`;
                }

                itemContainer.innerHTML = itemsHtml;
                totalsContainer.innerHTML = `
                <tr><td>SUBTOTAL</td><td>$${subtotal.toFixed(2)}</td></tr>
                <tr><td>GRAND TOTAL</td><td>$${subtotal.toFixed(2)}</td></tr>`;
            } else {
                itemContainer.innerHTML = '<p>Your cart is empty.</p>';
                checkoutBtn.disabled = true;
                checkoutBtn.textContent = 'Cart is Empty';
            }

            document.getElementById('checkout-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (shippingMsg) {
                    shippingMsg.textContent = '';
                    shippingMsg.className = 'form-message u-s-m-t-10';
                }
                checkoutMsg.textContent = '';

                const addressParts = {
                    line1: document.getElementById('ship-line1').value,
                    line2: document.getElementById('ship-line2').value,
                    city: document.getElementById('ship-city').value,
                    state: document.getElementById('ship-state').value,
                    zip: document.getElementById('ship-zip').value,
                    country: document.getElementById('ship-country').value || 'US'
                };

                if (!addressParts.line1 || !addressParts.city || !addressParts.state || !addressParts.zip) {
                    if (shippingMsg) {
                        shippingMsg.textContent = 'Please complete the required address fields.';
                        shippingMsg.className = 'form-message error';
                    }
                    return;
                }

                checkoutBtn.disabled = true;
                checkoutMsg.textContent = 'Redirecting to secure paymentâ€¦';

                try {
                    const addressString = buildAddressString(addressParts);
                    currentUser = await saveShippingAddress(addressString, currentUser);
                    hydrateShippingForm(currentUser);
                    if (shippingMsg) {
                        shippingMsg.textContent = 'Address saved.';
                        shippingMsg.className = 'form-message success';
                    }

                    const payload = { items: userCart, user_id: currentUser.user_id, user_email: currentUser.user_email, shipping_address: addressString};
                    const res = await fetch(`${window.API_ROOT}/create-checkout-session`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (res.ok && data.url) {
                        window.location.href = data.url;
                    } else {
                        throw new Error(data.error || 'Failed to create checkout session.');
                    }
                } catch (error) {
                    if (shippingMsg) {
                        shippingMsg.textContent = error.message;
                        shippingMsg.className = 'form-message error';
                    }
                    checkoutMsg.textContent = `Error: ${error.message}`;
                    checkoutBtn.disabled = false;
                }
            });
        })();

    </script>

</body>
</html>
