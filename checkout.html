<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Checkout</title>
    <link rel="stylesheet" href="css/vendor.css">
    <link rel="stylesheet" href="css/utility.css">
    <link rel="stylesheet" href="css/app.css">
    <script src="user.js"></script>
</head>
<body class="config">
    
    <div id="app">
       <div id="header-placeholder"></div>
        <script>
        (async () => {
        const el = document.getElementById('header-placeholder');
        const resp = await fetch('top_bar.html?_=' + Date.now()); // bust cache
        const html = await resp.text();
        el.innerHTML = html;

        // Execute any <script> tags inside the injected HTML

        document.dispatchEvent(new CustomEvent('user:changed'));
    
        el.querySelectorAll('script').forEach((old) => {
            const s = document.createElement('script');
            if (old.src) {
            s.src = old.src; s.async = old.async; s.defer = old.defer || false;
            } else {
            s.textContent = old.textContent;
            }
            document.head.appendChild(s);
        });

        // Call menu builder with already-fetched products if we have them
        const tryInit = () => {
            if (typeof window.initHeaderMenu === 'function') {
            window.initHeaderMenu(window.__ALL_PRODUCTS__ || null);
            }
        };
        // tiny delay to ensure the function is defined
        setTimeout(tryInit, 0);
        })();
        </script>

        <div class="app-content">
            <div class="u-s-p-y-60">
                <div class="section__content">
                    <div class="container">
                        <div class="breadcrumb">
                            <div class="breadcrumb__wrap">
                                <ul class="breadcrumb__list">
                                    <li class="has-separator"><a href="index.html">Home</a></li>
                                    <li class="is-marked"><a href="checkout.html">Checkout</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="u-s-p-b-60">
                <div class="section__content">
                    <div class="container">
                        <div class="checkout-f">
                            <div class="row">
                                <div class="col-lg-6">
                                    <h1 class="checkout-f__h1">DELIVERY INFORMATION</h1>
                                    <form class="checkout-f__delivery">
                                        </form>
                                </div>
                                <div class="col-lg-6">
                                    <h1 class="checkout-f__h1">ORDER SUMMARY</h1>
                                    <div class="o-summary">
                                        <div class="o-summary__section u-s-m-b-30">
                                            <div class="o-summary__item-wrap gl-scroll" id="cart-item-container">
                                                <p>Loading cart...</p>
                                            </div>
                                        </div>
                                        <div class="o-summary__section u-s-m-b-30">
                                            <div class="o-summary__box">
                                                <table class="o-summary__table">
                                                    <tbody id="cart-totals-container">
                                                        </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="o-summary__section u-s-m-b-30">
                                            <div class="o-summary__box">
                                                <h1 class="checkout-f__h1">PAYMENT</h1>
                                                <form id="checkout-form" class="checkout-f__payment">
                                                    <p class="u-s-m-b-15">Click the button below to proceed to our secure payment partner, Stripe. Your order details will be finalized there.</p>
                                                    <button class="btn btn--e-brand-b-2" id="checkout-btn" type="submit">Proceed to Secure Payment</button>
                                                    <div id="checkout-msg" class="form-message u-s-m-t-15"></div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-placeholder"></div>
        <script>
        (async () => {
            const el = document.getElementById('footer-placeholder');
            const resp = await fetch('footer.html?_=' + Date.now()); // Fetch footer.html
            const html = await resp.text();
            el.innerHTML = html;
        })();
        </script>
    </div>

    <script src="js/vendor.js"></script>
    <script src="js/jquery.shopnav.js"></script>
    <script src="js/app.js"></script>

    <script>
        // Load Header & Footer

        // Load Footer
        (async () => {
            const el = document.getElementById('footer-placeholder');
            const resp = await fetch('footer.html?_=' + Date.now());
            const html = await resp.text();
            el.innerHTML = html;
        })();

        // Checkout Logic...
        (async () => {
            // ... your existing checkout script remains here, unchanged ...
        })();

        // Checkout Logic
        (async () => {
            await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));

            const itemContainer = document.getElementById('cart-item-container');
            const totalsContainer = document.getElementById('cart-totals-container');
            const checkoutBtn = document.getElementById('checkout-btn');
            const checkoutMsg = document.getElementById('checkout-msg');
            let userCart = [];

            const user = window.getCurrentUser();
            if (!user) {
                window.location.href = 'signin.html';
                return;
            }

            const productsRes = await fetch(`${window.API_ROOT}/products`);
            const allProducts = await productsRes.json();
            const productsMap = new Map(allProducts.map(p => [String(p.product_id), p]));
            
            if (user.user_cart) {
                userCart = JSON.parse(user.user_cart);
                let itemsHtml = '';
                let subtotal = 0;

                for (const item of userCart) {
                    const product = productsMap.get(String(item.product_id));
                    if (product) {
                        const price = parseFloat(product.product_price) || 0;
                        const discount = parseFloat(product.product_discount) || 0;
                        const finalPrice = price * (1 - discount / 100);
                        subtotal += finalPrice * item.product_amount;

                        itemsHtml += `
                            <div class="o-card">
                                <div class="o-card__flex">
                                    <div class="o-card__img-wrap">
                                        <img class="u-img-fluid" src="${window.API_HOST}/${product.product_imagePath.replace(/^\//, '')}" alt="">
                                    </div>
                                    <div class="o-card__info-wrap">
                                        <span class="o-card__name"><a href="#">${product.product_name}</a></span>
                                        <span class="o-card__quantity">Quantity x ${item.product_amount}</span>
                                        <span class="o-card__price">$${finalPrice.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>`;
                    }
                }
                itemContainer.innerHTML = itemsHtml;
                totalsContainer.innerHTML = `
                    <tr>
                        <td>SUBTOTAL</td>
                        <td>$${subtotal.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>GRAND TOTAL</td>
                        <td>$${subtotal.toFixed(2)}</td>
                    </tr>`;
            }

            if (userCart.length === 0) {
                itemContainer.innerHTML = '<p>Your cart is empty.</p>';
                checkoutBtn.disabled = true;
                checkoutBtn.textContent = 'Cart is Empty';
            }

            document.getElementById('checkout-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                checkoutBtn.disabled = true;
                checkoutMsg.textContent = 'Redirecting to secure payment...';

                try {
                    const res = await fetch(`${window.API_ROOT}/create-checkout-session`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items: userCart })
                    });
                    
                    const data = await res.json();

                    if (res.ok && data.url) {
                        window.location.href = data.url;
                    } else {
                        throw new Error(data.error || 'Failed to create checkout session.');
                    }
                } catch (error) {
                    checkoutMsg.textContent = `Error: ${error.message}`;
                    checkoutBtn.disabled = false;
                }
            });
        })();
    </script>

</body>
</html>