<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="UTF-8">
    <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="images/favicon.png" rel="shortcut icon">
    <title>Kardiy - Elegant - Fast - Reliable - Cheap</title>

    <!--====== Google Font ======-->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet">

    <!--====== Vendor Css ======-->
    <link rel="stylesheet" href="css/vendor.css">

    <!--====== Utility-Spacing ======-->
    <link rel="stylesheet" href="css/utility.css">

    <!--====== App ======-->
    <link rel="stylesheet" href="css/app.css">
    <script src="user.js"></script>

</head>
<body class="config">
    <div class="preloader is-active">
        <div class="preloader__wrap">

            <img class="preloader__img" src="images/preloader.png" alt=""></div>
    </div>

    <!--====== Main App ======-->
    <div id="app">

        <!--====== Main Header ======-->
       <div id="header-placeholder"></div>
        <script>
        (async () => {
        const el = document.getElementById('header-placeholder');
        const resp = await fetch('top_bar.html?_=' + Date.now()); // bust cache
        const html = await resp.text();
        el.innerHTML = html;

        // Execute any <script> tags inside the injected HTML

        document.dispatchEvent(new CustomEvent('user:changed'));
    
        el.querySelectorAll('script').forEach((old) => {
            const s = document.createElement('script');
            if (old.src) {
            s.src = old.src; s.async = old.async; s.defer = old.defer || false;
            } else {
            s.textContent = old.textContent;
            }
            document.head.appendChild(s);
        });

        // Call menu builder with already-fetched products if we have them
        const tryInit = () => {
            if (typeof window.initHeaderMenu === 'function') {
            window.initHeaderMenu(window.__ALL_PRODUCTS__ || null);
            }
        };
        // tiny delay to ensure the function is defined
        setTimeout(tryInit, 0);
        })();
        </script>
        <!--====== End - Main Header ======-->
    

        <!--====== App Content ======-->
        <div class="app-content">

            <!--====== Section 1 ======-->
            <div class="u-s-p-y-60">

                <!--====== Section Content ======-->
                <div class="section__content">
                    <div class="container">
                        <div class="breadcrumb">
                            <div class="breadcrumb__wrap">
                                <ul class="breadcrumb__list">
                                    <li class="has-separator">

                                        <a href="index.html">Home</a></li>
                                    <li class="is-marked">

                                        <a href="cart.html">Cart</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--====== End - Section 1 ======-->


            <!--====== Section 2 ======-->
            <div class="u-s-p-b-60">

                <!--====== Section Intro ======-->
                <div class="section__intro u-s-m-b-60">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="section__text-wrap">
                                    <h1 class="section__heading u-c-secondary">SHOPPING CART</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--====== End - Section Intro ======-->


                <!--====== Section Content ======-->
                <div class="section__content">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12 col-md-12 col-sm-12 u-s-m-b-30">
                                <div class="table-responsive">
                                    <table class="table-p">
                                      <tbody id="cart-body">
                                        <tr><td><div class="u-s-m-b-30">Loading your cart…</div></td></tr>
                                      </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="route-box">
                                    <div class="route-box__g1">

                                        <a class="route-box__link" href="shop-side-version-2.html"><i class="fas fa-long-arrow-alt-left"></i>

                                            <span>CONTINUE SHOPPING</span></a></div>
                                    <div class="route-box__g2">

                                        <a class="route-box__link" href="cart.html"><i class="fas fa-trash"></i>

                                            <span>CLEAR CART</span></a>

                                        <a class="route-box__link" href="cart.html"><i class="fas fa-sync"></i>

                                            <span>UPDATE CART</span></a></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--====== End - Section Content ======-->
            </div>
            <!--====== End - Section 2 ======-->


            <!--====== Section 3 ======-->
            <div class="u-s-p-b-60">

                <!--====== Section Content ======-->
                <div class="section__content">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12 col-md-12 col-sm-12 u-s-m-b-30">
                                <form class="f-cart" action="checkout.html">
                                    <div class="row">
                                        <!-- <div class="col-lg-4 col-md-6 u-s-m-b-30">
                                            <div class="f-cart__pad-box">
                                                <h1 class="gl-h1">ESTIMATE SHIPPING AND TAXES</h1>

                                                <span class="gl-text u-s-m-b-30">Enter your destination to get a shipping estimate.</span>
                                                <div class="u-s-m-b-30">


                                                    <label class="gl-label" for="shipping-country">COUNTRY *</label><select class="select-box select-box--primary-style" id="shipping-country">
                                                        <option selected value="">Choose Country</option>
                                                        <option value="uae">United Arab Emirate (UAE)</option>
                                                        <option value="uk">United Kingdom (UK)</option>
                                                        <option value="us">United States (US)</option>
                                                    </select>
                                                </div>
                                                <div class="u-s-m-b-30">


                                                    <label class="gl-label" for="shipping-state">STATE/PROVINCE *</label><select class="select-box select-box--primary-style" id="shipping-state">
                                                        <option selected value="">Choose State/Province</option>
                                                        <option value="al">Alabama</option>
                                                        <option value="al">Alaska</option>
                                                        <option value="ny">New York</option>
                                                    </select>
                                                </div>
                                                <div class="u-s-m-b-30">

                                                    <label class="gl-label" for="shipping-zip">ZIP/POSTAL CODE *</label>

                                                    <input class="input-text input-text--primary-style" type="text" id="shipping-zip" placeholder="Zip/Postal Code"></div>
                                                <div class="u-s-m-b-30">

                                                    <a class="f-cart__ship-link btn--e-transparent-brand-b-2" href="cart.html">CALCULATE SHIPPING</a></div>

                                                <span class="gl-text">Note: There are some countries where free shipping is available otherwise our flat rate charges or country delivery charges will be apply.</span>
                                            </div>
                                        </div> -->
                                        <div class="col-lg-4 col-md-6 u-s-m-b-30">
                                            <div class="f-cart__pad-box">
                                                <h1 class="gl-h1">NOTE</h1>

                                                <span class="gl-text u-s-m-b-30">Add Special Note About Your Product</span>
                                                <div>

                                                    <label for="f-cart-note"></label><textarea class="text-area text-area--primary-style" id="f-cart-note"></textarea></div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4 col-md-6 u-s-m-b-30">
                                            <div class="f-cart__pad-box">
                                                <div class="u-s-m-b-30">
                                                    <table class="f-cart__table">
                                                        <tbody>
                                                            <tr>
                                                                <td>SHIPPING</td>
                                                                <td id="cart-shipping">$5.00</td>
                                                            </tr>
                                                            <tr>
                                                                <td>TAX</td>
                                                                <td id="cart-tax">$0.00</td>
                                                            </tr>
                                                            <tr>
                                                                <td>SUBTOTAL</td>
                                                                <td id="cart-subtotal">$0.00</td>
                                                            </tr>
                                                            <tr>
                                                                <td>GRAND TOTAL</td>
                                                                <td id="cart-grand">$0.00</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div>

                                                    <button class="btn btn--e-brand-b-2" type="submit"> PROCEED TO CHECKOUT</button></div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <!--====== End - Section Content ======-->
            </div>
            <!--====== End - Section 3 ======-->
        </div>
        <!--====== End - App Content ======-->


        <!--====== Main Footer ======-->
        <div id="footer-placeholder"></div>
        <script>
        (async () => {
            const el = document.getElementById('footer-placeholder');
            const resp = await fetch('footer.html?_=' + Date.now()); // Fetch footer.html
            const html = await resp.text();
            el.innerHTML = html;
        })();
        </script>
        </div>
    </div>
    <!--====== End - Main App ======-->


    <!--====== Google Analytics: change UA-XXXXX-Y to be your site's ID ======-->
    <script>
        window.ga = function() {
            ga.q.push(arguments)
        };
        ga.q = [];
        ga.l = +new Date;
        ga('create', 'UA-XXXXX-Y', 'auto');
        ga('send', 'pageview')
    </script>
    <script src="https://www.google-analytics.com/analytics.js" async defer></script>

    <!--====== Vendor Js ======-->
    <script src="js/vendor.js"></script>

    <!--====== jQuery Shopnav plugin ======-->
    <script src="js/jquery.shopnav.js"></script>

    <!--====== User state helpers ======-->

<script>
(() => {
  // =================================================================
  // 1. SETUP & CONFIGURATION
  // =================================================================

  const PRODUCTS_API = `${API_ROOT}/products`;
  const USERS_API = `${API_ROOT}/users`;

  const IMAGE_FALLBACK = '';
  const TAX_RATE = 0.10;      // 10%
  const SHIPPING_FLAT = 5.00; // $5 flat

  // This flag is the key fix to prevent race conditions from multiple renders.
  let isRendering = false;
  // A simple cache to avoid re-fetching all products repeatedly.
  let allProductsCache = null;

  // =================================================================
  // 2. HELPER UTILITIES
  // =================================================================
  const getUserSafe = () => (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
  const pick = (o, ...keys) => { for (const k of keys) { if (o && o[k] != null) return o[k]; } };
  const fmt = (n) => (parseFloat(n) || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
  const debounce = (fn, delay = 250) => {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn(...args), delay);
    };
  };

  // =================================================================
  // 3. API & DATA FETCHING
  // =================================================================
  /**
   * Fetches all products and caches them for the session to speed up lookups.
   */
  async function getAllProducts() {
    if (allProductsCache) return allProductsCache;
    const res = await fetch(PRODUCTS_API);
    if (!res.ok) throw new Error('Could not fetch products');
    const products = await res.json();
    // Create a Map for fast lookups by ID
    allProductsCache = new Map(products.map(p => [String(p.product_id), p]));
    return allProductsCache;
  }

  /**
   * Updates the quantity of a specific product in the user's cart.
   */
  async function updateCartAmount(productId, newAmount) {
    const user = getUserSafe();
    if (!user) { window.location.href = 'signin.html'; return; }
    const qty = Math.max(1, parseInt(newAmount, 10) || 1);
    const res = await fetch(`${USERS_API}/update-cart-amount`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ product_id: productId, product_amount: qty})
    });
    if (!res.ok) throw new Error(`Update failed (${res.status})`);
    const updatedUser = await res.json();
    if (typeof setCurrentUser === 'function') setCurrentUser(updatedUser);
  }

  /**
   * Removes a product completely from the user's cart.
   */
  async function removeFromCart(productId) {
    const user = getUserSafe();
    if (!user) { window.location.href = 'signin.html'; return; }
    const res = await fetch(`${USERS_API}/remove-from-cart`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ product_id: productId})
    });
    if (!res.ok) throw new Error(`Remove failed (${res.status})`);
    const updatedUser = await res.json();
    if (typeof setCurrentUser === 'function') setCurrentUser(updatedUser);
  }

  // =================================================================
  // 4. DOM MANIPULATION & RENDERING
  // =================================================================
  /**
   * Builds the HTML for a single row in the cart table.
   */
  function buildRow(product, cartItem) {
    const name = pick(product, 'product_name', 'name') || 'Product';
    const category = pick(product, 'product_category', 'category') || '';
    const price = parseFloat(pick(product, 'product_price', 'price') || 0);
    const productId = pick(product, 'product_id','rowid' );
    // --- START: With this more robust logic ---
    let imagePath = IMAGE_FALLBACK;
    try {
    let primaryPath = '';
    const v = pick(product, 'product_imagePath', 'image');

    if (v) {
        // This handles both new arrays and old JSON strings gracefully
        const pathArray = Array.isArray(v) ? v : JSON.parse(v);
        if (Array.isArray(pathArray) && pathArray.length > 0) {
        primaryPath = pathArray[0];
        }
    }
    
    if (primaryPath) {
        // If it's a full S3 URL, use it directly. Otherwise, build the path.
        imagePath = primaryPath.startsWith('http') ? primaryPath : `${API_HOST}/${primaryPath.replace(/^\/+/, '')}`;
    }
    } catch (e) {
    console.warn('Could not parse image path for product:', product.product_id, e);
    // The imagePath variable is already set to IMAGE_FALLBACK
    }
    // --- END: With this more robust logic ---
    const qty = Math.max(1, parseInt(cartItem.product_amount || '1', 10));
    const subtotal = price * qty;

    const tr = document.createElement('tr');
    tr.dataset.productId = cartItem.product_id;
    tr.innerHTML = `
      <td>
        <div class="table-p__box">
          <div class="table-p__img-wrap"><img class="u-img-fluid" src="${imagePath}" alt="${name}"></div>
          <div class="table-p__info">
            <span class="table-p__name"><a href="product-detail-variable.html?product_id=${productId}">${name}</a></span>
            ${category ? `<span class="table-p__category"><a href="#">${category}</a></span>` : ''}
          </div>
        </div>
      </td>
      <td><span class="table-p__price">${fmt(price)}</span></td>
      <td>
        <div class="table-p__quantity">
          <div class="input-counter">
            <span class="input-counter__minus fas fa-minus" data-action="decrease"></span>
            <input class="input-counter__text input-counter--text-primary-style" type="text" value="${qty}" data-min="1" data-max="1000">
            <span class="input-counter__plus fas fa-plus" data-action="increase"></span>
          </div>
        </div>
      </td>
      <td><span class="table-p__subtotal">${fmt(subtotal)}</span></td>
      <td>
        <div class="table-p__del-wrap"><a class="far fa-trash-alt table-p__delete-link" href="#" data-action="remove"></a></div>
      </td>`;
    return { tr, subtotal };
  }

  /**
   * Updates the grand total summary box.
   */
  function updateTotals(subtotal) {
    const tax = subtotal * TAX_RATE;
    const grand = subtotal + tax + SHIPPING_FLAT;
    document.getElementById('cart-subtotal').textContent = fmt(subtotal);
    document.getElementById('cart-tax').textContent = fmt(tax);
    document.getElementById('cart-shipping').textContent = fmt(SHIPPING_FLAT);
    document.getElementById('cart-grand').textContent = fmt(grand);
  }

  /**
   * The main function to render the entire cart. It's now faster and safer.
   */
  const renderCart = async () => {
    // FIX: Prevent multiple renders from running at the same time.
    if (isRendering) return;
    isRendering = true;

    const tbody = document.getElementById('cart-body');
    const user = getUserSafe();
    tbody.innerHTML = '<tr><td><div class="u-s-m-b-30">Loading your cart…</div></td></tr>';

    try {
      let cartItems = [];
      try { cartItems = JSON.parse(user?.user_cart || '[]'); } catch (e) {}
      if (!Array.isArray(cartItems) || cartItems.length === 0) {
        tbody.innerHTML = '<tr><td><div class="u-s-m-b-30">Your cart is empty.</div></td></tr>';
        updateTotals(0);
        return;
      }
      
      // FIX: Fetch all product data in parallel for huge performance gain.
      const productsMap = await getAllProducts();
      
      tbody.innerHTML = '';
      let currentSubtotal = 0;

      for (const item of cartItems) {
        const productDetails = productsMap.get(String(item.product_id));
        if (productDetails) {
          const { tr, subtotal } = buildRow(productDetails, item);
          tbody.appendChild(tr);
          currentSubtotal += subtotal;
        }
      }
      
      if (!tbody.children.length) {
         tbody.innerHTML = '<tr><td><div class="u-s-m-b-30">Could not load cart items. Please refresh.</div></td></tr>';
      }
      
      updateTotals(currentSubtotal);

    } catch (error) {
      console.error("Failed to render cart:", error);
      tbody.innerHTML = '<tr><td><div class="u-s-m-b-30">Error loading cart. Please try again.</div></td></tr>';
    } finally {
      // FIX: Release the render lock so the next render can run.
      isRendering = false;
    }
  };

  // =================================================================
  // 5. EVENT HANDLERS & INITIALIZATION
  // =================================================================
  /**
   * Sets up a single, efficient event listener for all cart actions.
   */
  function initializeCartActions() {
    const cartContainer = document.querySelector('.table-p');
    if (!cartContainer) return;

    // --- Handle Clicks (Remove, Increase, Decrease) ---
    cartContainer.addEventListener('click', async (e) => {
      const target = e.target;
      const action = target.dataset.action;
      if (!action) return;

      e.preventDefault();
      const row = target.closest('tr');
      const productId = row.dataset.productId;
      if (!productId) return;

      if (action === 'remove') {
        row.style.opacity = '0.5';
        await removeFromCart(productId);
      }

      if (action === 'increase' || action === 'decrease') {
        const input = row.querySelector('.input-counter__text');
        let qty = parseInt(input.value, 10);
        qty += (action === 'increase' ? 1 : -1);
        if (qty < 1) qty = 1;
        input.value = qty; // Optimistic UI update
        // Debounced to handle rapid clicks gracefully
        debouncedUpdate(productId, qty);
      }
    });

    // --- Handle Manual Quantity Changes ---
    cartContainer.addEventListener('change', (e) => {
        const input = e.target;
        if (!input.matches('.input-counter__text')) return;
        
        const row = input.closest('tr');
        const productId = row.dataset.productId;
        if (!productId) return;
        
        let qty = parseInt(input.value, 10) || 1;
        if (qty < 1) {
            qty = 1;
            input.value = 1; // Correct invalid input visually
        }
        debouncedUpdate(productId, qty);
    });
  }
  
  const debouncedUpdate = debounce((productId, qty) => updateCartAmount(productId, qty), 400);

  // --- Start the application ---
  document.addEventListener('DOMContentLoaded', async () => {
    initializeCartActions();
    if (typeof window.checkSession === 'function') {
      await window.checkSession();
    }
    await renderCart();
  });
  // Re-render the cart whenever the user state changes from another source
  document.addEventListener('user:changed', debounce(renderCart, 100));

})();
</script>

    <!--====== App ======-->
    <script src="js/app.js"></script>

    <!--====== Noscript ======-->
    <noscript>
        <div class="app-setting">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="app-setting__wrap">
                            <h1 class="app-setting__h1">JavaScript is disabled in your browser.</h1>

                            <span class="app-setting__text">Please enable JavaScript in your browser or upgrade to a JavaScript-capable browser.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </noscript>
</body>
</html>
