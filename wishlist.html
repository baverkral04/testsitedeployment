<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="UTF-8">
    <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="images/favicon.png" rel="shortcut icon">
    <title>Ludus - Electronics, Apparel, Computers, Books, DVDs & more</title>

    <!--====== Google Font ======-->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet">

    <!--====== Vendor Css ======-->
    <link rel="stylesheet" href="css/vendor.css">

    <!--====== Utility-Spacing ======-->
    <link rel="stylesheet" href="css/utility.css">

    <!--====== App ======-->
    <link rel="stylesheet" href="css/app.css">
    <script src="user.js"></script>
</head>
<body class="config">
    <div class="preloader is-active">
        <div class="preloader__wrap">

            <img class="preloader__img" src="images/preloader.png" alt=""></div>
    </div>

    <!--====== Main App ======-->
    <div id="app">

        <!--====== Main Header ======-->
       <div id="header-placeholder"></div>
        <script>
        (async () => {
        const el = document.getElementById('header-placeholder');
        const resp = await fetch('top_bar.html?_=' + Date.now()); // bust cache
        const html = await resp.text();
        el.innerHTML = html;

        // Execute any <script> tags inside the injected HTML

        document.dispatchEvent(new CustomEvent('user:changed'));
    
        el.querySelectorAll('script').forEach((old) => {
            const s = document.createElement('script');
            if (old.src) {
            s.src = old.src; s.async = old.async; s.defer = old.defer || false;
            } else {
            s.textContent = old.textContent;
            }
            document.head.appendChild(s);
        });

        // Call menu builder with already-fetched products if we have them
        const tryInit = () => {
            if (typeof window.initHeaderMenu === 'function') {
            window.initHeaderMenu(window.__ALL_PRODUCTS__ || null);
            }
        };
        // tiny delay to ensure the function is defined
        setTimeout(tryInit, 0);
        })();
        </script>
        <!--====== End - Main Header ======-->


        <!--====== App Content ======-->
        <div class="app-content">

            <!--====== Section 1 ======-->
            <div class="u-s-p-y-60">

                <!--====== Section Content ======-->
                <div class="section__content">
                    <div class="container">
                        <div class="breadcrumb">
                            <div class="breadcrumb__wrap">
                                <ul class="breadcrumb__list">
                                    <li class="has-separator">

                                        <a href="index.html">Home</a></li>
                                    <li class="is-marked">

                                        <a href="wishlist.html">Wishlist</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--====== End - Section 1 ======-->


            <!--====== Section 2 ======-->
            <div class="u-s-p-b-60">

                <!--====== Section Intro ======-->
                <div class="section__intro u-s-m-b-60">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="section__text-wrap">
                                    <h1 class="section__heading u-c-secondary">Wishlist</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--====== End - Section Intro ======-->


                <!--====== Section Content ======-->
                <div class="section__content">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12 col-md-12 col-sm-12">

                                <!--====== Wishlist Product ======-->

                                <!--====== End - Wishlist Product ======-->


                                <!--====== Wishlist Product ======-->
                                <!-- Dynamic Wishlist -->
                                <div id="wishlist-list"></div>
                                <!--====== End - Wishlist Product ======-->
                            </div>
                            <div class="col-lg-12">
                                <div class="route-box">
                                    <div class="route-box__g">

                                        <a class="route-box__link" href="shop-side-version-2.html"><i class="fas fa-long-arrow-alt-left"></i>

                                            <span>CONTINUE SHOPPING</span></a></div>
                                    <div class="route-box__g">

                                    <a class="route-box__link" href="#" id="wishlist-clear">
                                    <i class="fas fa-trash"></i><span>CLEAR WISHLIST</span>
                                    </a>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--====== End - Section Content ======-->
            </div>
            <!--====== End - Section 2 ======-->
        </div>
        <!--====== End - App Content ======-->


        <!--====== Main Footer ======-->
        <div id="footer-placeholder"></div>
        <script>
        (async () => {
            const el = document.getElementById('footer-placeholder');
            const resp = await fetch('footer.html?_=' + Date.now()); // Fetch footer.html
            const html = await resp.text();
            el.innerHTML = html;
        })();
        </script>
        </div>

        <!--====== Modal Section ======-->


        <!--====== Add to Cart Modal ======-->
        <div class="modal fade" id="add-to-cart">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content modal-radius modal-shadow">

                    <button class="btn dismiss-button fas fa-times" type="button" data-dismiss="modal"></button>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-lg-6 col-md-12">
                                <div class="success u-s-m-b-30">
                                    <div class="success__text-wrap"><i class="fas fa-check"></i>

                                        <span>Item is added successfully!</span></div>
                                    <div class="success__img-wrap">

                                        <img class="u-img-fluid" src="images/product/electronic/product1.jpg" alt=""></div>
                                    <div class="success__info-wrap">

                                        <span class="success__name">Beats Bomb Wireless Headphone</span>

                                        <span class="success__quantity">Quantity: 1</span>

                                        <span class="success__price">$170.00</span></div>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12">
                                <div class="s-option">

                                    <span class="s-option__text">1 item (s) in your cart</span>
                                    <div class="s-option__link-box">

                                        <a class="s-option__link btn--e-white-brand-shadow" data-dismiss="modal">CONTINUE SHOPPING</a>

                                        <a class="s-option__link btn--e-white-brand-shadow" href="cart.html">VIEW CART</a>

                                        <a class="s-option__link btn--e-brand-shadow" href="checkout.html">PROCEED TO CHECKOUT</a></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--====== End - Add to Cart Modal ======-->
        <!--====== End - Modal Section ======-->
    </div>
    <!--====== End - Main App ======-->


    <!--====== Google Analytics: change UA-XXXXX-Y to be your site's ID ======-->
    <script>
        window.ga = function() {
            ga.q.push(arguments)
        };
        ga.q = [];
        ga.l = +new Date;
        ga('create', 'UA-XXXXX-Y', 'auto');
        ga('send', 'pageview')
    </script>
    <script src="https://www.google-analytics.com/analytics.js" async defer></script>

    <!--====== Vendor Js ======-->
    <script src="js/vendor.js"></script>

    <!--====== jQuery Shopnav plugin ======-->
    <script src="js/jquery.shopnav.js"></script>

    <!--====== App ======-->
    <script src="js/app.js"></script>

    <!--====== Noscript ======-->
    <noscript>
        <div class="app-setting">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="app-setting__wrap">
                            <h1 class="app-setting__h1">JavaScript is disabled in your browser.</h1>

                            <span class="app-setting__text">Please enable JavaScript in your browser or upgrade to a JavaScript-capable browser.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </noscript>
 
<script>
(function(){
  /* ----------------------------- CONFIG ----------------------------- */
  const listEl = document.getElementById('wishlist-list');
  const clearBtn = document.getElementById('wishlist-clear');

  // Prefer globals from user.js; fall back to defaults

  const USER_API    = `${API_ROOT}/users`;
  const PRODUCTS_API = `${API_ROOT}/products`;
  const WISHLIST_GET_URL = `${USER_API}/wishlist`;
  const WISHLIST_REMOVE_URL = `${USER_API}/wishlist/remove`;
  const IMAGE_FALLBACK = 'images/product/default.jpg';
  const DEBUG = true;
  const log = (...a)=>DEBUG&&console.log('[Wishlist]',...a);

  /* -------------------------- USER HELPERS -------------------------- */
  const getCurrentUser = typeof window.getCurrentUser === 'function'
    ? window.getCurrentUser
    : () => { try { return JSON.parse(localStorage.getItem('currentUser')||'null'); } catch { return null; } };

  const setCurrentUser = typeof window.setCurrentUser === 'function'
    ? window.setCurrentUser
    : (u, silent = false) => {
        localStorage.setItem('currentUser', JSON.stringify(u));
        if (!silent) {
          document.dispatchEvent(new CustomEvent('user:changed', { detail: u }));
        }
      };

  function parseWishlist(u){
    if (!u) return [];
    let raw = u.user_wishlist ?? u.wishlist ?? [];
    if (typeof raw === 'string') { try { raw = JSON.parse(raw); } catch { raw = []; } }
    if (!Array.isArray(raw)) raw = [];
    // normalize to [{product_id: "str"}]
    const out = [];
    const seen = new Set();
    for (const it of raw){
      const pid = typeof it === 'object' && it !== null
        ? (it.product_id ?? it.id ?? it.rowid)
        : it;
      if (pid == null) continue;
      const s = String(pid);
      if (!seen.has(s)){ seen.add(s); out.push({ product_id: s }); }
    }
    return out;
  }

  function updateWishlistCountDisplay(){
    const u = getCurrentUser();
    const count = parseWishlist(u).length;
    document.querySelectorAll('[data-wishlist-count], #pd-wishlist-count')
      .forEach(el => { el.textContent = el.id === 'pd-wishlist-count' ? `(${count})` : String(count); });
  }

  async function fetchServerWishlist(){
    const u = getCurrentUser();
    if (!u) return [];
    const q = u.user_id ? `user_id=${encodeURIComponent(u.user_id)}` : `user_email=${encodeURIComponent(u.user_email)}`;
    const res = await fetch(`${WISHLIST_GET_URL}?${q}`);
    if (!res.ok) { log('GET wishlist failed', res.status); return []; }
    const list = await res.json();
    // Only update user state if wishlist has changed
    const currentWishlist = JSON.stringify(parseWishlist(u));
    const newWishlist = JSON.stringify(list);
    if (currentWishlist !== newWishlist) {
      const merged = { ...u, user_wishlist: newWishlist };
      setCurrentUser(merged, true); // silent to avoid triggering user:changed
    }
    return list;
  }

  /* ------------------------- PRODUCTS HELPERS ------------------------ */
  const money = (n) => Number(n||0).toLocaleString('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2});
  const getId = (p) => p?.rowid ?? p?.product_id ?? p?.id;

  function imageURL(p) {
    try {
      let path = '';
      const v = p.product_imagePath;
      if (!v) return IMAGE_FALLBACK;
      if (typeof v === 'string') {
        try { const arr = JSON.parse(v); if (Array.isArray(arr) && arr.length) path = arr[0]; }
        catch { path = v; }
      } else if (Array.isArray(v) && arr.length) path = v[0];
      if (!path) return IMAGE_FALLBACK;
      return `${API_HOST}/${String(path).replace(/^\/+/, '')}`;
    } catch { return IMAGE_FALLBACK; }
  }

  function productLink(p) {
    const img = encodeURIComponent(imageURL(p));
    return `product-detail-variable.html?product_id=${encodeURIComponent(getId(p))}&image=${img}`;
  }

  function priceNow(p) {
    const base = Number(p.product_price)||0;
    const d = Number(p.product_discount)||0;
    return d>0 ? base*(1-d/100) : base;
  }

  function indexProducts(list) {
    const m = new Map();
    (list||[]).forEach(p => {
      [p.rowid, p.product_id, p.id].forEach(k => { if (k!=null) m.set(String(k), p); });
    });
    return m;
  }

  function rowHTML(p, wishId) {
    const link = productLink(p);
    const now = priceNow(p);
    const cat = p.product_tree1 || 'General';
    const base = Number(p.product_price)||0;
    const hasDisc = Number(p.product_discount)>0;

    return `
      <div class="w-r u-s-m-b-30" data-wish-id="${String(wishId)}">
        <div class="w-r__container">
          <div class="w-r__wrap-1">
            <div class="w-r__img-wrap">
              <a href="${link}">
                <img class="u-img-fluid" src="${imageURL(p)}" alt="">
              </a>
            </div>
            <div class="w-r__info">
              <span class="w-r__name"><a href="${link}">${p.product_name || 'Product'}</a></span>
              <span class="w-r__category"><a href="shop-side-version-2.html">${cat}</a></span>
              <span class="w-r__price">
                ${money(now)}
                ${hasDisc ? `<span class="w-r__discount">${money(base)}</span>` : ''}
              </span>
            </div>
          </div>
          <div class="w-r__wrap-2">
            <a class="w-r__link btn--e-brand-b-2" data-action="add-to-cart">ADD TO CART</a>
            <a class="w-r__link btn--e-transparent-platinum-b-2" href="${link}">VIEW</a>
            <a class="w-r__link btn--e-transparent-platinum-b-2" href="#" data-action="remove">REMOVE</a>
          </div>
        </div>
      </div>
    `;
  }

  /* --------------------------- SERVER CALLS -------------------------- */
  async function serverWishlistRemove(pid){
    const u = getCurrentUser();
    if (!u) throw new Error('not-signed-in');

    const payload = { user_id: u.user_id, user_email: u.user_email, product_id: String(pid) };
    log('POST remove →', payload);

    const res = await fetch(WISHLIST_REMOVE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const txt = await res.text().catch(() => '');
      throw new Error(`Wishlist remove failed ${res.status}: ${txt}`);
    }
    const updated = await res.json().catch(() => ({}));

    if (updated && (updated.user_id !== undefined || updated.user_email !== undefined)) {
      setCurrentUser(updated, true); // silent to avoid triggering user:changed
    } else {
      // Fallback: optimistic local removal if server returned no user object
      const u2 = getCurrentUser() || {};
      let arr = parseWishlist(u2).filter(it => String(it.product_id) !== String(pid));
      u2.user_wishlist = JSON.stringify(arr);
      setCurrentUser(u2, true);
    }
    updateWishlistCountDisplay();
    return true;
  }

  /* --------------------------- RENDER / LOAD ------------------------- */
  // Cache products globally to avoid repeated fetches
  let cachedProducts = null;

  async function loadWishlist() {
    const user = getCurrentUser();
    if (!user) {
      listEl.innerHTML = `<div class="u-s-m-b-30" style="color:#666">Sign in to view your wishlist.</div>`;
      updateWishlistCountDisplay();
      return;
    }

    // Fetch wishlist from server
    const wish = await fetchServerWishlist();
    updateWishlistCountDisplay();

    if (!wish.length) {
      listEl.innerHTML = `<div class="u-s-m-b-30" style="color:#666">Your wishlist is empty.</div>`;
      return;
    }

    // Fetch products only if not cached
    if (!cachedProducts) {
      cachedProducts = (Array.isArray(window.__ALL_PRODUCTS__) && window.__ALL_PRODUCTS__.length)
        ? window.__ALL_PRODUCTS__
        : null;
      if (!cachedProducts) {
        try {
          const res = await fetch(PRODUCTS_API);
          if (res.ok) cachedProducts = await res.json();
        } catch (e) { log('products fetch error', e); }
      }
    }
    if (!cachedProducts || !cachedProducts.length) {
      listEl.innerHTML = `<div class="u-s-m-b-30" style="color:#b00">Could not load products.</div>`;
      return;
    }

    const pIndex = indexProducts(cachedProducts);
    const rows = [];
    for (const { product_id: wishId } of wish) {
      const p = pIndex.get(String(wishId));
      if (p) rows.push(rowHTML(p, wishId));
    }
    listEl.innerHTML = rows.join('') || `<div class="u-s-m-b-30" style="color:#666">Your wishlist is empty.</div>`;
  }

  /* ------------------------- EVENT DELEGATION ------------------------ */
  // Only ONE handler – calls server first, then updates UI.
  listEl.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;
    e.preventDefault();
    e.stopPropagation(); // prevent any other listener from racing this one

    const card = btn.closest('[data-wish-id]');
    const pid  = card?.getAttribute('data-wish-id');
    const action = btn.getAttribute('data-action');
    const user = getCurrentUser();

    if (!user) { alert('Please sign in.'); return; }

    // Handle ADD TO CART locally (your backend cart routes already exist if you want to wire them later)
    if (action === 'add-to-cart') {
      // simple local increment (you can swap to server call if desired)
      const raw = user.user_cart || '[]';
      let cart = [];
      try { cart = typeof raw === 'string' ? JSON.parse(raw) : raw; } catch { cart = []; }
      let found = cart.find(x => String(x.product_id) === String(pid));
      if (found) found.product_amount = Math.max(1, Number(found.product_amount||1)) + 1;
      else cart.push({ product_id: String(pid), product_amount: 1 });
      user.user_cart = JSON.stringify(cart);
      setCurrentUser(user, true); // silent to avoid triggering user:changed
      document.dispatchEvent(new CustomEvent('cart:changed'));
      alert('Added to cart!');
      return;
    }

    if (action === 'remove') {
      if (!pid) { console.warn('No product_id on row'); return; }
      try {
        await serverWishlistRemove(pid);
        // Remove the row from DOM without re-fetching products
        if (card && card.parentElement) card.parentElement.removeChild(card);
        // If list is empty now, show empty message
        const u = getCurrentUser();
        if (parseWishlist(u).length === 0) {
          listEl.innerHTML = `<div class="u-s-m-b-30" style="color:#666">Your wishlist is empty.</div>`;
        }
      } catch (err) {
        console.error('Remove failed:', err);
        alert('Could not remove from wishlist. Please try again.');
      }
      return;
    }
  });

  // Clear wishlist -> keep server in sync by removing each item
  clearBtn?.addEventListener('click', async (e) => {
    e.preventDefault();
    const u = getCurrentUser();
    if (!u) return;
    const items = parseWishlist(u);
    if (!items.length) return;
    if (!confirm('Clear your entire wishlist?')) return;

    try {
      await Promise.allSettled(items.map(it => serverWishlistRemove(it.product_id)));
    } finally {
      // final UI refresh
      await loadWishlist();
    }
  });

  // Re-render if auth state changes
  let isLoading = false;
  document.addEventListener('user:changed', async () => {
    if (isLoading) return; // Prevent re-entry
    isLoading = true;
    try {
      await loadWishlist();
    } finally {
      isLoading = false;
    }
  });

  // Initial load
  (async () => {
    if (isLoading) return;
    isLoading = true;
    try {
      await loadWishlist();
    } finally {
      isLoading = false;
    }
  })();
})();
</script>


</body>
</html>