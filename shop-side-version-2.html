<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="UTF-8">
    <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="images/favicon.png" rel="shortcut icon">
    <title>Ludus - Electronics, Apparel, Computers, Books, DVDs & more</title>

    <!-- Google Font (Already in top_bar.html, but kept here for standalone use) -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet">

    <!-- Vendor CSS -->
    <link rel="stylesheet" href="css/vendor.css">

    <!-- Utility CSS -->
    <link rel="stylesheet" href="css/utility.css">
    <script src="user.js" ></script>
    <!-- App CSS -->
    <link rel="stylesheet" href="css/app.css">
    <style>
        /* Custom loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Error message styling */
        .error-message {
            background-color: #ffebee;
            color: #b71c1c;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
        }
        /* Product card enhancements */
        .product-m__content {
            min-height: 180px;
        }
        .product-m__name {
            height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .no-products {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        /* Filter-tree links and icons in old black */
        #filter-tree a.f-link {
            color: #000000;
        }
        #filter-tree a.f-link:hover {
            color: #000000;
        }
        #filter-tree li.is-expanded > a.f-link {
            color: #000000;
        }
        #filter-tree .js-shop-category-span {
            color: #000000;
        }
    </style>
</head>
<body class="config">
    <div class="preloader is-active">
        <div class="preloader__wrap">
            <img class="preloader__img" src="images/preloader.png" alt="">
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <!-- Main App -->
    <div id="app">
        <!-- Include Top Bar -->
        <!-- Replace this with your include mechanism, e.g., {% include 'top_bar.html' %} for Flask/Jinja2 -->
       <div id="header-placeholder"></div>
        <script>
        (async () => {
        const el = document.getElementById('header-placeholder');
        const resp = await fetch('top_bar.html?_=' + Date.now()); // bust cache
        const html = await resp.text();
        el.innerHTML = html;

        // Execute any <script> tags inside the injected HTML

        document.dispatchEvent(new CustomEvent('user:changed'));
    
        el.querySelectorAll('script').forEach((old) => {
            const s = document.createElement('script');
            if (old.src) {
            s.src = old.src; s.async = old.async; s.defer = old.defer || false;
            } else {
            s.textContent = old.textContent;
            }
            document.head.appendChild(s);
        });

        // Call menu builder with already-fetched products if we have them
        const tryInit = () => {
            if (typeof window.initHeaderMenu === 'function') {
            window.initHeaderMenu(window.__ALL_PRODUCTS__ || null);
            }
        };
        // tiny delay to ensure the function is defined
        setTimeout(tryInit, 0);
        })();
        </script>

        <!-- App Content -->
        <div class="app-content">
            <!-- Section 1 -->
            <div class="u-s-p-y-90">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-3 col-md-12">
                            <div class="shop-w-master">
                                <h1 class="shop-w-master__heading u-s-m-b-30">
                                    <i class="fas fa-filter u-s-m-r-8"></i>
                                    <span>FILTERS</span>
                                </h1>
                                <div class="shop-w-master__sidebar">
                                    <div id="filter-tree"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-9 col-md-12">
                            <div class="shop-p">
                                <div class="shop-p__toolbar u-s-m-b-30">
                                    <div class="shop-p__meta-wrap u-s-m-b-60">
                                        <span class="shop-p__meta-text-1" id="results-count">Loading products...</span>
                                        <div class="shop-p__meta-text-2" id="related-searches"></div>
                                    </div>
                                    <div class="shop-p__tool-style">
                                        <div class="tool-style__group u-s-m-b-8">
                                            <span class="js-shop-grid-target is-active">Grid</span>
                                            <span class="js-shop-list-target">List</span>
                                        </div>
                                        <form>
                                            <div class="tool-style__form-wrap">
                                                <div class="u-s-m-b-8">
                                                    <select class="select-box select-box--transparent-b-2" id="page-size">
                                                        <option>Show: 8</option>
                                                        <option selected>Show: 12</option>
                                                        <option>Show: 16</option>
                                                        <option>Show: 28</option>
                                                    </select>
                                                </div>
                                                <div class="u-s-m-b-8">
                                                    <select class="select-box select-box--transparent-b-2" id="sort-by">
                                                        <option selected>Sort By: Newest Items</option>
                                                        <option>Sort By: Latest Items</option>
                                                        <option>Sort By: Best Selling</option>
                                                        <option>Sort By: Best Rating</option>
                                                        <option>Sort By: Lowest Price</option>
                                                        <option>Sort By: Highest Price</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <div class="shop-p__collection">
                                    <div class="row is-grid-active" id="product-grid"></div>
                                </div>
                                <div class="u-s-p-y-60">
                                    <ul class="shop-p__pagination" id="pagination"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End - Section 1 -->
        </div>
        <!-- End - App Content -->

        <!-- Main Footer -->
        <div id="footer-placeholder"></div>
        <script>
        (async () => {
            const el = document.getElementById('footer-placeholder');
            const resp = await fetch('footer.html?_=' + Date.now()); // Fetch footer.html
            const html = await resp.text();
            el.innerHTML = html;
        })();
        </script>
        </div>
    </div>
    <!-- End - Main App -->

    <!-- Google Analytics -->
    <script>
        window.ga = function() {
            ga.q.push(arguments)
        };
        ga.q = [];
        ga.l = +new Date;
        ga('create', 'UA-XXXXX-Y', 'auto');
        ga('send', 'pageview')
    </script>
    <script src="https://www.google-analytics.com/analytics.js" async defer></script>

    <!-- Vendor JS -->
    <script src="js/vendor.js"></script>

    <!-- jQuery Shopnav plugin -->
    <script src="js/jquery.shopnav.js"></script>

    <!-- App JS -->
    <script src="js/app.js"></script>
<script>
(() => {
  const DEBUG = true;
  const log = (...a)=>DEBUG&&console.log('[CART-GRID]',...a);

  // --- endpoints (mirror product page) ---
  const ADD_TO_CART_URL = `${API_ROOT}/users/add-to-cart`;
  // --- user helpers (from user.js) ---
  function getUserSafe(){ try { return (typeof getCurrentUser==='function') ? getCurrentUser() : null; } catch { return null; } }
  function setUserSafe(u){ try { if (typeof setCurrentUser==='function') setCurrentUser(u); } catch {} }

  // --- cart normalization/helpers ---
  function _normItem(x){
    const pid = (x && (x.product_id ?? x.id ?? x.rowid));
    const amt = parseInt(x?.product_amount, 10) || 1;
    return pid != null ? { product_id: String(pid), product_amount: Math.max(0, amt) } : null;
  }
  function parseCart(u) {
    if (!u) return [];
    try {
      let arr = JSON.parse(u.user_cart || '[]');
      if (!Array.isArray(arr)) arr = [];
      return arr.map(_normItem).filter(Boolean);
    } catch { return []; }
  }
  function writeCart(arr){
    const u = getUserSafe() || {};
    u.user_cart = JSON.stringify((arr||[]).map(_normItem).filter(Boolean));
    setUserSafe(u);
    return u;
  }
  function getCart(){ return parseCart(getUserSafe()); }
  function setCartItemAmount(pid, amount){
    const sid = String(pid);
    let arr = getCart();
    const idx = arr.findIndex(it => it.product_id === sid);
    if (amount <= 0) {
      if (idx >= 0) arr.splice(idx, 1);
    } else {
      if (idx >= 0) arr[idx].product_amount = amount;
      else arr.push({ product_id: sid, product_amount: amount });
    }
    return writeCart(arr);
  }
  function bumpCartLocal(pid, qty){
    const sid = String(pid);
    const arr = getCart();
    const idx = arr.findIndex(it => it.product_id === sid);
    if (idx >= 0) {
      arr[idx].product_amount = (parseInt(arr[idx].product_amount,10)||0) + qty;
    } else {
      arr.push({ product_id: sid, product_amount: qty });
    }
    return writeCart(arr);
  }
  function clearCartLocal(){
    writeCart([]);
  }
  function cartItemsCount(u){
    return parseCart(u || getUserSafe()).reduce((s, it) => s + (parseInt(it.product_amount,10)||0), 0);
  }
  function updateHeaderBadges() {
    const total = cartItemsCount();
    const els = document.querySelectorAll('[data-role="cart-count"], #cart-count, .js-cart-count');
    els.forEach(el => el.textContent = total);
  }

  // Expose a tiny API so the cart page can keep local state in sync after "Delete all"
  window.__cart = Object.freeze({
    clearCartLocal, getCart, writeCart, setCartItemAmount
  });

  // --- product id finder (no markup changes needed) ---
  function extractPidFromCard(card) {
    const link = card.querySelector('a[href*="product-detail-variable.html"]')
             || card.querySelector('.product-m__name a')
             || card.querySelector('.product-m__thumb a');
    if (link) {
      try {
        const url = new URL(link.getAttribute('href'), location.href);
        const pid = url.searchParams.get('product_id');
        if (pid) return String(pid);
      } catch {}
    }
    return null;
  }

  // --- server call (do NOT trust response to overwrite local cart) ---
  async function addToCartServer(pid, qty){
    const u = getUserSafe(); if (!u) throw new Error('not-signed-in');
    const payload = {
      product_id: String(pid),
      product_amount: Math.max(1, parseInt(qty||1,10) || 1),
      user_id: u.user_id,
      user_email: u.user_email
    };
    const res = await fetch(ADD_TO_CART_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('add-to-cart failed '+res.status);
    // Intentionally ignore full user snapshot to avoid resurrecting stale items.
    // We'll only *optionally* read product_amount for this pid if API returns it.
    try { return await res.json(); } catch { return {}; }
  }

  // --- UX helpers ---
  function flashButton(btn, text='Added!', ms=900){
    if (!btn) return;
    const old = btn.textContent;
    btn.textContent = text;
    btn.classList.add('is-success');
    setTimeout(() => {
      btn.textContent = old;
      btn.classList.remove('is-success');
    }, ms);
  }

  // --- wire a single card ---
  function wireCard(card){
    const btn = card.querySelector('.product-m__add-cart a, a[data-modal-id="#add-to-cart"]');
    if (!btn || btn.dataset.cartWired === '1') return;

    const pid = extractPidFromCard(card);
    if (!pid) { log('skip card: no product_id'); return; }

    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (btn.getAttribute('aria-busy') === 'true') return; // debounce rapid clicks

      const user = getUserSafe();
      if (!user) { location.href = 'signin.html'; return; }

      const qty = 1; // grid adds are usually +1

      // Optimistic UI
      btn.setAttribute('aria-busy','true');
      const oldHtml = btn.innerHTML;
      btn.innerHTML = 'Adding...';

      try {
        const resp = await addToCartServer(pid, qty);

        // Local truth: only bump the clicked item
        bumpCartLocal(pid, qty);

        // If server returns an authoritative amount ONLY for this pid, sync that one line (ignore other ids)
        if (resp && (resp.product_id || resp.user_cart)) {
          try {
            if (resp.product_id && resp.product_amount != null) {
              const amt = Math.max(1, parseInt(resp.product_amount,10) || 1);
              setCartItemAmount(resp.product_id, amt);
            } else if (resp.user_cart) {
              const srv = Array.isArray(resp.user_cart) ? resp.user_cart
                         : JSON.parse(resp.user_cart);
              const row = (srv||[]).map(_normItem).find(x => x && x.product_id === String(pid));
              if (row && row.product_amount != null) {
                setCartItemAmount(pid, Math.max(1, parseInt(row.product_amount,10)||1));
              }
            }
          } catch {}
        }

        updateHeaderBadges();
        flashButton(btn, 'Added!');
      } catch (err) {
        console.error('[add-to-cart]', err);
        alert('Could not add to cart. Please try again.');
      } finally {
        btn.removeAttribute('aria-busy');
        btn.innerHTML = oldHtml;
      }
    });

    btn.dataset.cartWired = '1';
  }

  // --- wire all visible cards ---
  function wireAll(root=document){
    root.querySelectorAll('.product-m').forEach(wireCard);
  }

  // --- bootstrap + observe re-renders/pagination ---
  document.addEventListener('DOMContentLoaded', () => {
    wireAll();

    const grid = document.getElementById('product-grid');
    if (!grid) return;

    const mo = new MutationObserver(() => {
      requestAnimationFrame(() => wireAll(grid));
    });
    mo.observe(grid, { childList:true, subtree:true });

    // Keep badge accurate on load
    updateHeaderBadges();
  });
})();
</script> 
<script>
(() => {
  const DEBUG = true;
  const log = (...a)=>DEBUG&&console.log('[WISHLIST-GRID]',...a);

  // --- endpoints (same as product detail page) ---
  const WISHLIST_ADD_URL    = `${API_ROOT}/users/wishlist/add`;
  const WISHLIST_REMOVE_URL = `${API_ROOT}/users/wishlist/remove`;
  const WISHLIST_GET_URL    = `${API_ROOT}/users/wishlist`;

  // --- user helpers (from user.js) ---
  function getUserSafe(){ try { return (typeof getCurrentUser==='function') ? getCurrentUser() : null; } catch { return null; } }
  function setUserSafe(u){ try { if (typeof setCurrentUser==='function') setCurrentUser(u); } catch {} }

  // --- wishlist helpers (normalized to [{product_id:"…"}]) ---
  function parseWishlist(u) {
    if (!u) return [];
    try {
      let arr = JSON.parse(u.user_wishlist || '[]');
      if (!Array.isArray(arr)) arr = [];
      return arr.map(it => {
        if (typeof it === 'string' || typeof it === 'number') return { product_id: String(it) };
        const pid = it?.product_id ?? it?.id ?? it?.rowid;
        return pid != null ? { product_id: String(pid) } : null;
      }).filter(Boolean);
    } catch { return []; }
  }
  function isInWishlist(u, pid) {
    if (!u) return false;
    const sid = String(pid);
    return parseWishlist(u).some(x => String(x.product_id) === sid);
  }

  // --- UI helpers (do NOT rely on duplicate IDs) ---
  function markHeart(anchor, active) {
    if (!anchor) return;
    const icon = anchor.querySelector('i');
    const text = anchor.querySelector('span');
    if (icon) {
      icon.classList.toggle('far', !active);
      icon.classList.toggle('fas',  active);
    }
    if (text) text.textContent = active ? 'In Wishlist' : 'Add to Wishlist';
  }
  function updateCardCount(anchor) {
    const wrapper = anchor.closest('.pd-detail__inline, .product-m__hover, .product-m__content');
    const countEl = wrapper ? wrapper.querySelector('.pd-detail__click-count') : null;
    if (!countEl) return;
    const u = getUserSafe();
    countEl.textContent = `(${parseWishlist(u).length})`;
  }

  // --- server calls ---
  async function serverWishlistAdd(pid) {
    const u = getUserSafe(); if (!u) throw new Error('not-signed-in');
    const res = await fetch(WISHLIST_ADD_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ user_id: u.user_id, user_email: u.user_email, product_id: String(pid) })
    });
    if (!res.ok) throw new Error('wishlist add failed '+res.status);
    return res.json();
  }
  async function serverWishlistRemove(pid) {
    const u = getUserSafe(); if (!u) throw new Error('not-signed-in');
    const res = await fetch(WISHLIST_REMOVE_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ user_id: u.user_id, user_email: u.user_email, product_id: String(pid) })
    });
    if (!res.ok) throw new Error('wishlist remove failed '+res.status);
    return res.json();
  }
  async function syncWishlistFromServer() {
    const u = getUserSafe(); if (!u) return;
    const q = u.user_id ? `user_id=${encodeURIComponent(u.user_id)}` :
                          `user_email=${encodeURIComponent(u.user_email)}`;
    try {
      const res = await fetch(`${WISHLIST_GET_URL}?${q}`);
      if (!res.ok) return;
      const list = await res.json();        // ← expects normalized list
      setUserSafe({ ...u, user_wishlist: JSON.stringify(list) });
    } catch {}
  }

  // --- find product_id for a card (no markup changes required) ---
  function extractPidFromCard(card) {
    const link = card.querySelector('a[href*="product-detail-variable.html"]')
             || card.querySelector('.product-m__name a')
             || card.querySelector('.product-m__thumb a');
    if (link) {
      try {
        const url = new URL(link.getAttribute('href'), location.href);
        const pid = url.searchParams.get('product_id');
        if (pid) return String(pid);
      } catch {}
    }
    const a = card.querySelector('.pd-wishlist-link');
    if (a?.dataset.wishId) return String(a.dataset.wishId);
    return null;
  }

  // --- wire a single product card ---
  function wireCard(card) {
    const anchor = card.querySelector('.pd-wishlist-link');
    if (!anchor || anchor.dataset.wired === '1') return;

    const pid = extractPidFromCard(card);
    if (!pid) { log('skip card: no product_id'); return; }

    anchor.dataset.wishId = pid;

    // initial paint
    const u = getUserSafe();
    markHeart(anchor, isInWishlist(u, pid));
    updateCardCount(anchor);

    anchor.addEventListener('click', async (e) => {
      e.preventDefault();
      const user = getUserSafe();
      if (!user) { location.href = 'signin.html'; return; }

      const inList = isInWishlist(user, pid);
      try {
        const updated = inList ? await serverWishlistRemove(pid)
                               : await serverWishlistAdd(pid);

        // Prefer server's updated user row; fallback to optimistic local edit
        if (updated && (updated.user_wishlist !== undefined || updated.user_id !== undefined)) {
          setUserSafe(updated);
        } else {
          let arr = parseWishlist(user);
          const sid = String(pid);
          arr = inList ? arr.filter(x => String(x.product_id) !== sid)
                       : [...arr, { product_id: sid }];
          setUserSafe({ ...user, user_wishlist: JSON.stringify(arr) });
        }

        const u2 = getUserSafe();
        markHeart(anchor, isInWishlist(u2, pid));
        updateCardCount(anchor);

        // Optional: update a header badge if you have one
        const headerBadge = document.querySelector('[data-role="wishlist-count"], #wishlist-count, .js-wishlist-count');
        if (headerBadge) headerBadge.textContent = parseWishlist(u2).length;

      } catch (err) {
        console.error('[wishlist-grid]', err);
        alert('Could not update wishlist. Please try again.');
      }
    });

    anchor.dataset.wired = '1';
  }

  // --- wire all cards currently in DOM ---
  function wireAllCards(root = document) {
    root.querySelectorAll('.product-m').forEach(wireCard);
  }

  // --- bootstrap: sync once, wire now, then watch for re-renders/pagination ---
  document.addEventListener('DOMContentLoaded', async () => {
    await syncWishlistFromServer();
    wireAllCards();

    const grid = document.getElementById('product-grid');
    if (!grid) return;
    const mo = new MutationObserver(() => {
      // defer to next frame to avoid thrashing during bulk updates
      requestAnimationFrame(() => wireAllCards(grid));
    });
    mo.observe(grid, { childList: true, subtree: true });
  });
})();
</script>
    <!-- Dynamic Product Loading Script -->
    <script>
    (async () => {
        // Configuration
        const DEBUG = true;
        const log = (...args) => DEBUG && console.log('[DEBUG]', ...args);
        const PRODUCTS_API = `${API_ROOT}/products`; // Use global API_ROOT
        const PAGE_SIZE = 9; // 3x3 grid per page
        const IMAGE_FALLBACK = 'images/product/default.jpg';

        // Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const productGrid = document.getElementById('product-grid');
        const pagination = document.getElementById('pagination');
        const resultsCount = document.getElementById('results-count');
        const filterTree = document.getElementById('filter-tree');
        const relatedSearches = document.getElementById('related-searches');

        // State
        let products = [];
        let filteredProducts = [];
        let currentPage = 1;
        let currentFilter = {};

        // Helper Functions
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function showError(message) {
            productGrid.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function formatPrice(price) {
            return Number(price).toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            });
        }

        function renderStars(rating) {
            rating = Number(rating) || 0;
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5 ? 1 : 0;
            const emptyStars = 5 - fullStars - halfStar;
            let starsHTML = '';
            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<i class="fas fa-star"></i>';
            }
            if (halfStar) {
                starsHTML += '<i class="fas fa-star-half-alt"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<i class="far fa-star"></i>';
            }
            return starsHTML;
        }

        function getAverageStars(reviewsText) {
            try {
                const arr = JSON.parse(reviewsText || '[]');
                if (!Array.isArray(arr) || !arr.length) return 0;
                const total = arr.reduce((sum, r) => sum + Number(r.star || 0), 0);
                return total / arr.length;
            } catch (_) {
                return 0;
            }
        }

        // ===============================================
        // THE NEW HELPER FUNCTION RIGHT HERE 👇
        // ===============================================
        function getImageUrl(product) {
            try {
                let primaryPath = '';
                const v = product.product_imagePath;

                if (v) {
                    // This handles both new arrays and old JSON strings gracefully
                    const pathArray = Array.isArray(v) ? v : JSON.parse(v);
                    if (Array.isArray(pathArray) && pathArray.length > 0) {
                        primaryPath = pathArray[0];
                    }
                }
              
                if (primaryPath) {
                    // If it's a full S3 URL, use it directly. Otherwise, build the path.
                    return primaryPath.startsWith('http') ? primaryPath : `${API_HOST}/${primaryPath.replace(/^\/+/, '')}`;
                }
            } catch (e) {
                console.warn('Could not parse image path for product:', product.product_id);
            }
            return IMAGE_FALLBACK; // Return the fallback if anything fails
        }


        // Data Fetching
        async function fetchProducts() {
            showLoading();
            try {
                log('Fetching products from API...');
                const response = await fetch(PRODUCTS_API);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                products = await response.json();
                log(`Fetched ${products.length} products`);
                products.sort((a, b) => {
                    const indexA = Number(a.product_index) || 0;
                    const indexB = Number(b.product_index) || 0;
                    return indexA - indexB;
                });
                filteredProducts = [...products];
                buildFilterTree();
                renderProducts();
                updateResultsCount();
            } catch (error) {
                console.error('Error fetching products:', error);
                showError('Could not load products. Please try again later.');
            } finally {
                hideLoading();
            }
        }

        
        // Filter Tree
        function buildFilterTree() {
            if (!products.length) return;
            const treeFields = Object.keys(products[0])
                .filter(key => /^product_tree\d+$/.test(key))
                .sort((a, b) => parseInt(a.match(/\d+$/)[0]) - parseInt(b.match(/\d+$/)[0]));
            const categoryTree = {};
            products.forEach(product => {
                let current = categoryTree;
                treeFields.forEach((field, idx) => {
                    const value = product[field] || 'Uncategorized';
                    if (idx === treeFields.length - 1) {
                        if (!current[value]) current[value] = true;
                    } else {
                        if (!current[value]) current[value] = {};
                        current = current[value];
                    }
                });
            });

            function renderNode(node, level) {
                let html = '<ul>';
                Object.keys(node).sort().forEach(key => {
                    const hasChildren = node[key] && typeof node[key] === 'object';
                    const field = treeFields[level];
                    const isActive = currentFilter[field] === key;
                    html += `<li class="${hasChildren ? 'has-list' : ''} ${isActive ? 'is-expanded' : ''}">` +
                            `<a href="#" class="f-link" data-type="${field}" data-value="${key}">${key}</a>`;
                    if (hasChildren) {
                        html += `<span class="js-shop-category-span ${isActive ? 'fas fa-minus' : 'fas fa-plus'} u-s-m-l-6"></span>`;
                        let childHtml = renderNode(node[key], level + 1);
                        if (!isActive) {
                            childHtml = childHtml.replace(/^<ul>/, '<ul style="display:none;">');
                        }
                        html += childHtml;
                    }
                    html += '</li>';
                });
                html += '</ul>';
                return html;
            }

            filterTree.innerHTML = renderNode(categoryTree, 0);
            document.querySelectorAll('.f-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const type = this.dataset.type;
                    const value = this.dataset.value;
                    const idx = treeFields.indexOf(type);
                    if (currentFilter[type] === value) {
                        treeFields.slice(idx).forEach(f => currentFilter[f] = null);
                    } else {
                        currentFilter[type] = value;
                        treeFields.slice(idx + 1).forEach(f => currentFilter[f] = null);
                    }
                    currentPage = 1;
                    applyFilters();
                    buildFilterTree();
                    renderProducts();
                });
            });
        }

        function applyFilters() {
            const treeFields = Object.keys(products[0]).filter(k => /^product_tree\d+$/.test(k));
            filteredProducts = products.filter(product => {
                return treeFields.every(field => {
                    const val = currentFilter[field];
                    return !val || product[field] === val;
                });
            });
            updateResultsCount();
        }

        function updateResultsCount() {
            const count = filteredProducts.length;
            resultsCount.textContent = `FOUND ${count} RESULT${count !== 1 ? 'S' : ''}`;
            if (currentFilter.tree1) {
                relatedSearches.innerHTML = `
                    <span>Related Searches:</span>
                    <a class="gl-tag btn--e-brand-shadow" href="#">${currentFilter.tree1}</a>
                    ${currentFilter.tree2 ? `<a class="gl-tag btn--e-brand-shadow" href="#">${currentFilter.tree2}</a>` : ''}
                    ${currentFilter.tree3 ? `<a class="gl-tag btn--e-brand-shadow" href="#">${currentFilter.tree3}</a>` : ''}
                `;
            } else {
                relatedSearches.innerHTML = '';
            }
        }

        // Product Rendering
        function renderProducts() {
            if (filteredProducts.length === 0) {
                productGrid.innerHTML = '<div class="col-12 no-products">No products found matching your criteria</div>';
                pagination.innerHTML = '';
                return;
            }

            const totalPages = Math.ceil(filteredProducts.length / PAGE_SIZE);
            const startIndex = (currentPage - 1) * PAGE_SIZE;
            const endIndex = Math.min(startIndex + PAGE_SIZE, filteredProducts.length);
            const pageProducts = filteredProducts.slice(startIndex, endIndex);

            let html = '';
            pageProducts.forEach(product => {
                const saleBadge = product.product_sale === '1'
                    ? '<div class="product-m__sale-badge"><span class="u-s-m-b-4 d-block">SALE</span></div>'
                    : '';
                // ADD THIS ONE LINE IN ITS PLACE
                const imagePath = getImageUrl(product);
                const price = Number(product.product_price) || 0;
                const discountPct = Number(product.product_discount) || 0;
                const hasDiscount = discountPct > 0;
                const discountedPrice = hasDiscount ? price * (1 - discountPct / 100) : price;
                const avgStars = getAverageStars(product.product_reviews);
                const priceHTML = hasDiscount
                    ? `<span class="product-m__price-discounted">${formatPrice(discountedPrice)}</span> <span class="product-m__discount">${formatPrice(price)}</span>`
                    : `<span class="product-m__price">${formatPrice(price)}</span>`;

                html += `
                <div class="col-lg-4 col-md-6 col-sm-6">
                    <div class="product-m">
                        <div class="product-m__thumb">
                            ${saleBadge}
                            <a class="aspect aspect--bg-grey aspect--square u-d-block" href="product-detail-variable.html?product_id=${product.product_id}&image=${encodeURIComponent(imagePath)}">
                                <img class="aspect__img" src="${imagePath}" alt="${product.product_name}">
                            </a>
                            <div class="product-m__quick-look">
                                <a class="fas fa-search" data-modal="modal" data-modal-id="#quick-look" data-tooltip="tooltip" data-placement="top" title="Quick Look"></a>
                            </div>
                            <div class="product-m__add-cart">
                                <a class="btn--e-brand" data-modal="modal" data-modal-id="#add-to-cart">Add to Cart</a>
                            </div>
                        </div>
                        <div class="product-m__content">
                            <div class="product-m__category">
                                <a href="shop-side-version-2.html">${product.product_tree1 || 'General'}</a>
                            </div>
                            <div class="product-m__name">
                                <a href="product-detail-variable.html?product_id=${product.product_id}&image=${encodeURIComponent(imagePath)}">
                                    ${product.product_name || 'Product'}
                                </a>
                            </div>
                            <div class="product-m__rating gl-rating-style">
                                ${renderStars(avgStars)}
                                <span class="product-m__review"></span>
                            </div>
                            <div class="product-m__price">
                                ${priceHTML}
                            </div>
                            <div class="product-m__hover">
                                <div class="product-m__preview-description">
                                    <span>${product.product_description || 'No description available'}</span>
                                </div>
                                <div class="u-s-m-b-15">
                                <div class="pd-detail__inline">
                                    <span class="pd-detail__click-wrap">
                                    <a id="pd-wishlist-btn" href="#" class="pd-wishlist-link" data-tooltip="tooltip" title="Add to Wishlist">
                                        <i id="pd-wishlist-icon" class="far fa-heart u-s-m-r-6"></i>
                                        <span id="pd-wishlist-text">Add to Wishlist</span>
                                    </a>
                                    <span class="pd-detail__click-count" id="pd-wishlist-count">(0)</span>
                                    </span>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });

            productGrid.innerHTML = html;
            renderPagination(totalPages);
        }
        
        function renderPagination(totalPages) {
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            let html = '';
            const maxPagesToShow = 5;
            let startPage, endPage;
            if (totalPages <= maxPagesToShow) {
                startPage = 1;
                endPage = totalPages;
            } else {
                const maxPagesBeforeCurrent = Math.floor(maxPagesToShow / 2);
                const maxPagesAfterCurrent = Math.ceil(maxPagesToShow / 2) - 1;
                if (currentPage <= maxPagesBeforeCurrent) {
                    startPage = 1;
                    endPage = maxPagesToShow;
                } else if (currentPage + maxPagesAfterCurrent >= totalPages) {
                    startPage = totalPages - maxPagesToShow + 1;
                    endPage = totalPages;
                } else {
                    startPage = currentPage - maxPagesBeforeCurrent;
                    endPage = currentPage + maxPagesAfterCurrent;
                }
            }
            if (currentPage > 1) {
                html += `<li><a href="#" data-page="${currentPage - 1}"><i class="fas fa-angle-left"></i></a></li>`;
            }
            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="${i === currentPage ? 'is-active' : ''}">` +
                        `<a href="#" data-page="${i}">${i}</a></li>`;
            }
            if (currentPage < totalPages) {
                html += `<li><a href="#" data-page="${currentPage + 1}"><i class="fas fa-angle-right"></i></a></li>`;
            }
            pagination.innerHTML = html;
            document.querySelectorAll('#pagination a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentPage = parseInt(this.dataset.page);
                    renderProducts();
                });
            });
        }

        // Initialization
        fetchProducts();

        // Sort event listener
        document.getElementById('sort-by').addEventListener('change', function() {
            const sortBy = this.value;
            if (sortBy.includes('Price')) {
                filteredProducts.sort((a, b) => {
                    const priceA = parseFloat(a.product_price) || 0;
                    const priceB = parseFloat(b.product_price) || 0;
                    return sortBy.includes('Lowest') ? priceA - priceB : priceB - priceA;
                });
            } else if (sortBy.includes('Newest') || sortBy.includes('Latest')) {
                filteredProducts.sort((a, b) => {
                    const indexA = parseInt(a.product_index) || 0;
                    const indexB = parseInt(b.product_index) || 0;
                    return indexB - indexA;
                });
            } else if (sortBy.includes('Rating')) {
                filteredProducts.sort((a, b) => {
                    const ratingA = getAverageStars(a.product_reviews);
                    const ratingB = getAverageStars(b.product_reviews);
                    return ratingB - ratingA;
                });
            }
            currentPage = 1;
            renderProducts();
        });

        // Page size event listener
        document.getElementById('page-size').addEventListener('change', function() {
            currentPage = 1;
            renderProducts();
        });
    })();
    </script>

    <!-- Noscript -->
    <noscript>
        <div class="app-setting">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="app-setting__wrap">
                            <h1 class="app-setting__h1">JavaScript is disabled in your browser.</h1>
                            <span class="app-setting__text">Please enable JavaScript in your browser or upgrade to a JavaScript-capable browser.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </noscript>


</body>
</html>