<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="UTF-8">
    <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="images/favicon.png" rel="shortcut icon">
    <title>Kardiy - Elegant - Fast - Reliable - Cheap</title>

    <!-- Google Font (Already in top_bar.html, but kept here for standalone use) -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet">

    <!-- Vendor CSS -->
    <link rel="stylesheet" href="css/vendor.css">

    <!-- Utility CSS -->
    <link rel="stylesheet" href="css/utility.css">
    <script src="user.js" ></script>
    <!-- App CSS -->
    <link rel="stylesheet" href="css/app.css">
    <style>
      /* ---------- Layout chrome ---------- */
      .shop-w-master {
        position: sticky;
        top: 120px;
        padding: 28px 24px;
        border-radius: 24px;
        background: linear-gradient(145deg, rgba(241, 245, 249, 0.95) 0%, rgba(229, 231, 235, 0.85) 100%);
        box-shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(148, 163, 184, 0.25);
      }

      .shop-w-master__heading {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.25rem;
        letter-spacing: 0.04em;
        color: #0f172a;
      }

      #filter-tree ul {
        list-style: none;
        padding-left: 0;
        margin: 0;
      }

      #filter-tree li {
        position: relative;
        padding: 10px 14px;
        margin-bottom: 6px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.65);
        border: 1px solid transparent;
        transition: all 0.25s ease;
      }

      #filter-tree li.has-list {
        padding-right: 38px;
      }

      #filter-tree li:hover {
        border-color: rgba(59, 130, 246, 0.35);
        transform: translateX(3px);
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      }

      #filter-tree li.is-expanded {
        border-color: rgba(79, 70, 229, 0.5);
        background: linear-gradient(135deg, rgba(224, 231, 255, 0.95), rgba(199, 210, 254, 0.85));
      }

      #filter-tree a.f-link {
        color: #1f2937;
        font-weight: 600;
        letter-spacing: 0.03em;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      #filter-tree a.f-link:hover {
        color: #4338ca;
      }

      #filter-tree .js-shop-category-span {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #6366f1;
        font-size: 0.85rem;
        background: rgba(99, 102, 241, 0.12);
        border-radius: 50%;
        width: 26px;
        height: 26px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
      }

      #filter-tree .js-shop-category-span:hover {
        background: rgba(99, 102, 241, 0.18);
      }

      .shop-p__toolbar {
        padding: 28px;
        border-radius: 24px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(226, 232, 240, 0.7);
        box-shadow: 0 18px 48px rgba(15, 23, 42, 0.08);
      }

      .shop-p__meta-wrap {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px;
        margin-bottom: 28px;
      }

      #results-count {
        font-weight: 700;
        letter-spacing: 0.08em;
        color: #0f172a;
      }

      #related-searches {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
        color: #475569;
      }

      #related-searches span {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6366f1;
      }

      #related-searches a {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.12);
        color: #4338ca;
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        border: 1px solid rgba(99, 102, 241, 0.2);
        text-decoration: none;
      }

      #related-searches a:hover {
        background: rgba(99, 102, 241, 0.2);
        color: #312e81;
      }

      .tool-style__group {
        background: rgba(148, 163, 184, 0.15);
        padding: 4px;
        border-radius: 999px;
        display: inline-flex;
        gap: 4px;
      }

      .tool-style__group span {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        background: transparent;
        color: #475569;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .tool-style__group span::before {
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        font-size: 0.85rem;
      }

      .js-shop-grid-target::before { content: "\f00a"; }
      .js-shop-list-target::before { content: "\f03a"; }

      .tool-style__group span:hover {
        color: #1d4ed8;
      }

      .tool-style__group span.is-active {
        background: linear-gradient(135deg, #6366f1, #3b82f6);
        color: #ffffff;
        box-shadow: 0 12px 30px rgba(99, 102, 241, 0.35);
      }

      .tool-style__form-wrap {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .select-box.select-box--transparent-b-2 {
        border-radius: 14px;
        padding: 10px 42px 10px 16px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(248, 250, 252, 0.9);
        color: #0f172a;
        font-weight: 600;
        letter-spacing: 0.04em;
        min-width: 180px;
      }

      .select-box.select-box--transparent-b-2:focus {
        border-color: rgba(99, 102, 241, 0.65);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        outline: none;
      }

      /* ---------- Product grid ---------- */
      #product-grid {
        row-gap: 32px;
      }

      .product-m {
        border-radius: 22px;
        overflow: hidden;
        background: #ffffff;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.7);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }

      .product-m:hover {
        transform: translateY(-6px);
        box-shadow: 0 26px 55px rgba(15, 23, 42, 0.14);
      }

      .product-m__thumb {
        border-bottom: 1px solid rgba(226, 232, 240, 0.7);
        position: relative;
      }

      .product-m__sale-badge span {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 999px;
        background: linear-gradient(135deg, #f97316, #fb923c);
        color: #ffffff;
        font-weight: 700;
        letter-spacing: 0.08em;
      }

      .product-m__hover {
        background: rgba(248, 250, 252, 0.95);
        border-radius: 18px;
        padding: 18px;
        box-shadow: inset 0 1px 0 rgba(226, 232, 240, 0.65);
      }

      .product-m__rating i {
        color: #f59e0b;
        margin-right: 2px;
      }

      .product-m__discount {
        color: #94a3b8;
        text-decoration: line-through;
      }

      .product-m__price-discounted {
        color: #f97316;
      }

      .product-m__add-cart .btn--e-brand {
        border-radius: 14px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 700;
      }

      .product-m__add-cart .btn--e-brand.is-success {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        border-color: transparent;
      }

      .pd-detail__click-wrap {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        color: #475569;
      }

      .pd-detail__click-wrap i.fas {
        color: #ef4444;
      }

      .no-products {
        padding: 60px;
        border-radius: 24px;
        text-align: center;
        background: rgba(248, 250, 252, 0.95);
        border: 2px dashed rgba(203, 213, 225, 0.9);
        color: #475569;
        font-weight: 600;
      }

      .error-message {
        padding: 48px;
        border-radius: 20px;
        background: rgba(254, 242, 242, 0.85);
        color: #b91c1c;
        font-weight: 600;
        text-align: center;
        box-shadow: inset 0 0 0 1px rgba(248, 113, 113, 0.35);
      }

      .shop-p__pagination li a {
        border-radius: 12px;
        padding: 10px 16px;
        font-weight: 600;
        letter-spacing: 0.05em;
        color: #334155;
        border: 1px solid rgba(226, 232, 240, 0.6);
      }

      .shop-p__pagination li.is-active a,
      .shop-p__pagination li a:hover {
        background: linear-gradient(135deg, #6366f1, #3b82f6);
        border-color: transparent;
        color: #ffffff;
        box-shadow: 0 12px 30px rgba(99, 102, 241, 0.35);
      }

      /* ---------- Skeleton state ---------- */
      #product-grid[data-loading="true"] {
        opacity: 0.7;
      }

      .product-skeleton {
        border-radius: 22px;
        background: linear-gradient(135deg, rgba(226, 232, 240, 0.7), rgba(241, 245, 249, 0.8));
        padding: 20px;
        display: grid;
        gap: 16px;
        box-shadow: inset 0 0 0 1px rgba(226, 232, 240, 0.8);
        overflow: hidden;
      }

      .product-skeleton__media,
      .product-skeleton__line {
        position: relative;
        overflow: hidden;
        border-radius: 16px;
        background: rgba(226, 232, 240, 0.65);
      }

      .product-skeleton__media {
        aspect-ratio: 1 / 1;
      }

      .product-skeleton__line { height: 14px; }
      .product-skeleton__line--short { width: 55%; }

      .product-skeleton__media::after,
      .product-skeleton__line::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(110deg, transparent 0%, rgba(255,255,255,0.6) 50%, transparent 100%);
        animation: shimmer 1.2s ease-in-out infinite;
      }

      @keyframes shimmer {
        from { transform: translateX(-100%); }
        to { transform: translateX(100%); }
      }

      .loading-overlay {
        backdrop-filter: blur(8px);
        background: rgba(15, 23, 42, 0.12);
      }

      /* ---------- Responsive tweaks ---------- */
      @media (max-width: 991px) {
        .shop-w-master {
          position: static;
          margin-bottom: 32px;
        }

        .shop-p__toolbar {
          padding: 22px;
        }
      }

      @media (max-width: 575px) {
        .shop-p__toolbar {
          padding: 18px;
        }

        .tool-style__form-wrap {
          width: 100%;
        }
      }
    </style>
</head>
<body class="config">
    <div class="preloader is-active">
        <div class="preloader__wrap">
            <img class="preloader__img" src="images/preloader.png" alt="">
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <!-- Main App -->
    <div id="app">
        <!-- Include Top Bar -->
        <!-- Replace this with your include mechanism, e.g., {% include 'top_bar.html' %} for Flask/Jinja2 -->
       <div id="header-placeholder"></div>
        <script>
        (async () => {
        const el = document.getElementById('header-placeholder');
        const resp = await fetch('top_bar.html?_=' + Date.now()); // bust cache
        const html = await resp.text();
        el.innerHTML = html;

        document.dispatchEvent(new CustomEvent('user:changed'));

        el.querySelectorAll('script').forEach((old) => {
            const s = document.createElement('script');
            if (old.src) {
            s.src = old.src; s.async = old.async; s.defer = old.defer || false;
            } else {
            s.textContent = old.textContent;
            }
            document.head.appendChild(s);
        });

        const tryInit = () => {
            if (typeof window.initHeaderMenu === 'function') {
            window.initHeaderMenu(window.__ALL_PRODUCTS__ || null);
            }
        };
        setTimeout(tryInit, 0);
        })();
        </script>

        <!-- App Content -->
        <div class="app-content">
            <!-- Section 1 -->
            <div class="u-s-p-y-90">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-3 col-md-12">
                            <div class="shop-w-master">
                                <h1 class="shop-w-master__heading u-s-m-b-30">
                                    <i class="fas fa-filter u-s-m-r-8"></i>
                                    <span>FILTERS</span>
                                </h1>
                                <div class="shop-w-master__sidebar">
                                    <div id="filter-tree"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-9 col-md-12">
                            <div class="shop-p">
                                <div class="shop-p__toolbar u-s-m-b-30">
                                    <div class="shop-p__meta-wrap u-s-m-b-60">
                                        <span class="shop-p__meta-text-1" id="results-count">Loading products...</span>
                                        <div class="shop-p__meta-text-2" id="related-searches"></div>
                                    </div>
                                    <div class="shop-p__tool-style">
                                        <div class="tool-style__group u-s-m-b-8">
                                            <span class="js-shop-grid-target is-active" role="button" tabindex="0" aria-pressed="true">Grid</span>
                                            <span class="js-shop-list-target" role="button" tabindex="0" aria-pressed="false">List</span>
                                        </div>
                                        <form>
                                            <div class="tool-style__form-wrap">
                                                <div class="u-s-m-b-8">
                                                    <select class="select-box select-box--transparent-b-2" id="page-size">
                                                        <option>Show: 8</option>
                                                        <option selected>Show: 12</option>
                                                        <option>Show: 16</option>
                                                        <option>Show: 28</option>
                                                    </select>
                                                </div>
                                                <div class="u-s-m-b-8">
                                                    <select class="select-box select-box--transparent-b-2" id="sort-by">
                                                        <option selected>Sort By: Newest Items</option>
                                                        <option>Sort By: Latest Items</option>
                                                        <option>Sort By: Best Selling</option>
                                                        <option>Sort By: Best Rating</option>
                                                        <option>Sort By: Lowest Price</option>
                                                        <option>Sort By: Highest Price</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <div class="shop-p__collection">
                                    <div class="row is-grid-active" id="product-grid"></div>
                                </div>
                                <div class="u-s-p-y-60">
                                    <ul class="shop-p__pagination" id="pagination"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End - Section 1 -->
        </div>
        <!-- End - App Content -->

        <!-- Main Footer -->
        <div id="footer-placeholder"></div>
        <script>
        (async () => {
            const el = document.getElementById('footer-placeholder');
            const resp = await fetch('footer.html?_=' + Date.now()); // Fetch footer.html
            const html = await resp.text();
            el.innerHTML = html;
        })();
        </script>
        </div>
    </div>
    <!-- End - Main App -->

    <!-- Google Analytics -->
    <script>
        window.ga = function() {
            ga.q.push(arguments)
        };
        ga.q = [];
        ga.l = +new Date;
        ga('create', 'UA-XXXXX-Y', 'auto');
        ga('send', 'pageview')
    </script>
    <script src="https://www.google-analytics.com/analytics.js" async defer></script>

    <!-- Vendor JS -->
    <script src="js/vendor.js"></script>

    <!-- jQuery Shopnav plugin -->
    <script src="js/jquery.shopnav.js"></script>

    <!-- App JS -->
    <script src="js/app.js"></script>
<script>
(() => {
  const DEBUG = true;
  const log = (...a)=>DEBUG&&console.log('[CART-GRID]',...a);

  // --- endpoints (mirror product page) ---
  const ADD_TO_CART_URL = `${API_ROOT}/users/add-to-cart`;
  // --- user helpers (from user.js) ---
  function getUserSafe(){ try { return (typeof getCurrentUser==='function') ? getCurrentUser() : null; } catch { return null; } }
  function setUserSafe(u){ try { if (typeof setCurrentUser==='function') setCurrentUser(u); } catch {} }

  // --- cart normalization/helpers ---
  function _normItem(x){
    const pid = (x && (x.product_id ?? x.id ?? x.rowid));
    const amt = parseInt(x?.product_amount, 10) || 1;
    return pid != null ? { product_id: String(pid), product_amount: Math.max(0, amt) } : null;
  }
  function parseCart(u) {
    if (!u) return [];
    try {
      let arr = JSON.parse(u.user_cart || '[]');
      if (!Array.isArray(arr)) arr = [];
      return arr.map(_normItem).filter(Boolean);
    } catch { return []; }
  }
  function writeCart(arr){
    const u = getUserSafe() || {};
    u.user_cart = JSON.stringify((arr||[]).map(_normItem).filter(Boolean));
    setUserSafe(u);
    return u;
  }
  function getCart(){ return parseCart(getUserSafe()); }
  function setCartItemAmount(pid, amount){
    const sid = String(pid);
    let arr = getCart();
    const idx = arr.findIndex(it => it.product_id === sid);
    if (amount <= 0) {
      if (idx >= 0) arr.splice(idx, 1);
    } else {
      if (idx >= 0) arr[idx].product_amount = amount;
      else arr.push({ product_id: sid, product_amount: amount });
    }
    return writeCart(arr);
  }
  function clearCartLocal(){
    writeCart([]);
  }
  function cartItemsCount(u){
    return parseCart(u || getUserSafe()).reduce((s, it) => s + (parseInt(it.product_amount,10)||0), 0);
  }
  function updateHeaderBadges() {
    const total = cartItemsCount();
    const els = document.querySelectorAll('[data-role="cart-count"], #cart-count, .js-cart-count');
    els.forEach(el => el.textContent = total);
  }

  // Expose a tiny API so the cart page can keep local state in sync after "Delete all"
  window.__cart = Object.freeze({
    clearCartLocal, getCart, writeCart, setCartItemAmount
  });

  // --- product id finder (no markup changes needed) ---
  function extractPidFromCard(card) {
    const link = card.querySelector('a[href*="product-detail-variable.html"]')
             || card.querySelector('.product-m__name a')
             || card.querySelector('.product-m__thumb a');
    if (link) {
      try {
        const url = new URL(link.getAttribute('href'), location.href);
        const pid = url.searchParams.get('product_id');
        if (pid) return String(pid);
      } catch {}
    }
    return null;
  }

  // --- server call (do NOT trust response to overwrite local cart) ---
  async function addToCartServer(pid, qty){
    const u = getUserSafe(); if (!u) throw new Error('not-signed-in');
    const payload = {
      product_id: String(pid),
      product_amount: Math.max(1, parseInt(qty||1,10) || 1),
      user_id: u.user_id,
      user_email: u.user_email
    };
    const res = await fetch(ADD_TO_CART_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('add-to-cart failed '+res.status);
    try {
      const updated = await res.json();
      setUserSafe(updated);
      return updated;
    } catch {
      return {};
    }
  }

  // --- UX helpers ---
  function flashButton(btn, text='Added!', ms=900){
    if (!btn) return;
    const old = btn.textContent;
    btn.textContent = text;
    btn.classList.add('is-success');
    setTimeout(() => {
      btn.textContent = old;
      btn.classList.remove('is-success');
    }, ms);
  }

  // --- wire a single card ---
  function wireCard(card){
    const btn = card.querySelector('.product-m__add-cart a, a[data-modal-id="#add-to-cart"]');
    if (!btn || btn.dataset.cartWired === '1') return;

    const pid = extractPidFromCard(card);
    if (!pid) { log('skip card: no product_id'); return; }

    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (btn.getAttribute('aria-busy') === 'true') return; // debounce rapid clicks

      const user = getUserSafe();
      if (!user) { location.href = 'signin.html'; return; }

      const qty = 1; // grid adds are usually +1

      // Optimistic UI
      btn.setAttribute('aria-busy','true');
      const oldHtml = btn.innerHTML;
      btn.innerHTML = 'Adding...';

      try {
        const resp = await addToCartServer(pid, qty);

        // If server returns an authoritative amount ONLY for this pid, sync that one line (ignore other ids)
        if (resp && (resp.product_id || resp.user_cart)) {
          try {
            if (resp.product_id && resp.product_amount != null) {
              const amt = Math.max(1, parseInt(resp.product_amount,10) || 1);
              setCartItemAmount(resp.product_id, amt);
            } else if (resp.user_cart) {
              const srv = Array.isArray(resp.user_cart) ? resp.user_cart
                         : JSON.parse(resp.user_cart);
              const row = (srv||[]).map(_normItem).find(x => x && x.product_id === String(pid));
              if (row && row.product_amount != null) {
                setCartItemAmount(pid, Math.max(1, parseInt(row.product_amount,10)||1));
              }
            }
          } catch {}
        }

        updateHeaderBadges();
        flashButton(btn, 'Added!');
      } catch (err) {
        console.error('[add-to-cart]', err);
        showToast('We couldn\'t add that item to your cart. Please try again.', { type: 'error' });
      } finally {
        btn.removeAttribute('aria-busy');
        btn.innerHTML = oldHtml;
      }
    });

    btn.dataset.cartWired = '1';
  }

  // --- wire all visible cards ---
  function wireAll(root=document){
    root.querySelectorAll('.product-m').forEach(wireCard);
  }

  // --- bootstrap + observe re-renders/pagination ---
  document.addEventListener('DOMContentLoaded', () => {
    wireAll();

    const grid = document.getElementById('product-grid');
    if (!grid) return;

    const mo = new MutationObserver(() => {
      requestAnimationFrame(() => wireAll(grid));
    });
    mo.observe(grid, { childList:true, subtree:true });

    // Keep badge accurate on load
    updateHeaderBadges();
  });
})();
</script> 
<script>
(() => {
  const DEBUG = true;
  const log = (...a)=>DEBUG&&console.log('[WISHLIST-GRID]',...a);

  // --- endpoints (same as product detail page) ---
  const WISHLIST_ADD_URL    = `${API_ROOT}/users/wishlist/add`;
  const WISHLIST_REMOVE_URL = `${API_ROOT}/users/wishlist/remove`;
  const WISHLIST_GET_URL    = `${API_ROOT}/users/wishlist`;

  // --- user helpers (from user.js) ---
  function getUserSafe(){ try { return (typeof getCurrentUser==='function') ? getCurrentUser() : null; } catch { return null; } }
  function setUserSafe(u){ try { if (typeof setCurrentUser==='function') setCurrentUser(u); } catch {} }

  // --- wishlist helpers (normalized to [{product_id:"â€¦"}]) ---
  function parseWishlist(u) {
    if (!u) return [];
    try {
      let arr = JSON.parse(u.user_wishlist || '[]');
      if (!Array.isArray(arr)) arr = [];
      return arr.map(it => {
        if (typeof it === 'string' || typeof it === 'number') return { product_id: String(it) };
        const pid = it?.product_id ?? it?.id ?? it?.rowid;
        return pid != null ? { product_id: String(pid) } : null;
      }).filter(Boolean);
    } catch { return []; }
  }
  function isInWishlist(u, pid) {
    if (!u) return false;
    const sid = String(pid);
    return parseWishlist(u).some(x => String(x.product_id) === sid);
  }

  // --- UI helpers (do NOT rely on duplicate IDs) ---
  function markHeart(anchor, active) {
    if (!anchor) return;
    const icon = anchor.querySelector('i');
    const text = anchor.querySelector('span');
    if (icon) {
      icon.classList.toggle('far', !active);
      icon.classList.toggle('fas',  active);
    }
    if (text) text.textContent = active ? 'In Wishlist' : 'Add to Wishlist';
  }
  function updateCardCount(anchor) {
    const wrapper = anchor.closest('.pd-detail__inline, .product-m__hover, .product-m__content');
    const countEl = wrapper ? wrapper.querySelector('.pd-detail__click-count') : null;
    if (!countEl) return;
    const u = getUserSafe();
    countEl.textContent = `(${parseWishlist(u).length})`;
  }

  // --- server calls ---
  async function serverWishlistAdd(pid) {
    const u = getUserSafe(); if (!u) throw new Error('not-signed-in');
    const res = await fetch(WISHLIST_ADD_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({
        product_id: String(pid),
        user_id: u.user_id,
        user_email: u.user_email
      })
    });
    if (!res.ok) throw new Error('wishlist add failed '+res.status);
    return res.json();
  }
  async function serverWishlistRemove(pid) {
    const u = getUserSafe(); if (!u) throw new Error('not-signed-in');
    const res = await fetch(WISHLIST_REMOVE_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({
        product_id: String(pid),
        user_id: u.user_id,
        user_email: u.user_email
      })
    });
    if (!res.ok) throw new Error('wishlist remove failed '+res.status);
    return res.json();
  }
  async function syncWishlistFromServer() {
    const u = getUserSafe(); if (!u) return;
    const q = u.user_id ? `user_id=${encodeURIComponent(u.user_id)}` :
                          `user_email=${encodeURIComponent(u.user_email)}`;
    try {
      const res = await fetch(`${WISHLIST_GET_URL}?${q}`, { credentials: 'include' });
      if (!res.ok) return;
      const list = await res.json();        // â† expects normalized list
      setUserSafe({ ...u, user_wishlist: JSON.stringify(list) });
    } catch {}
  }

  // --- find product_id for a card (no markup changes required) ---
  function extractPidFromCard(card) {
    const link = card.querySelector('a[href*="product-detail-variable.html"]')
             || card.querySelector('.product-m__name a')
             || card.querySelector('.product-m__thumb a');
    if (link) {
      try {
        const url = new URL(link.getAttribute('href'), location.href);
        const pid = url.searchParams.get('product_id');
        if (pid) return String(pid);
      } catch {}
    }
    const a = card.querySelector('.pd-wishlist-link');
    if (a?.dataset.wishId) return String(a.dataset.wishId);
    return null;
  }

  // --- wire a single product card ---
  function wireCard(card) {
    const anchor = card.querySelector('.pd-wishlist-link');
    if (!anchor || anchor.dataset.wired === '1') return;

    const pid = extractPidFromCard(card);
    if (!pid) { log('skip card: no product_id'); return; }

    anchor.dataset.wishId = pid;

    // initial paint
    const u = getUserSafe();
    markHeart(anchor, isInWishlist(u, pid));
    updateCardCount(anchor);

    anchor.addEventListener('click', async (e) => {
      e.preventDefault();
      const user = getUserSafe();
      if (!user) { location.href = 'signin.html'; return; }

      const inList = isInWishlist(user, pid);
      try {
        const updated = inList ? await serverWishlistRemove(pid)
                               : await serverWishlistAdd(pid);

        // Prefer server's updated user row; fallback to optimistic local edit
        if (updated && (updated.user_wishlist !== undefined || updated.user_id !== undefined)) {
          setUserSafe(updated);
        } else {
          let arr = parseWishlist(user);
          const sid = String(pid);
          arr = inList ? arr.filter(x => String(x.product_id) !== sid)
                       : [...arr, { product_id: sid }];
          setUserSafe({ ...user, user_wishlist: JSON.stringify(arr) });
        }

        const u2 = getUserSafe();
        markHeart(anchor, isInWishlist(u2, pid));
        updateCardCount(anchor);

        // Optional: update a header badge if you have one
        const headerBadge = document.querySelector('[data-role="wishlist-count"], #wishlist-count, .js-wishlist-count');
        if (headerBadge) headerBadge.textContent = parseWishlist(u2).length;

      } catch (err) {
        console.error('[wishlist-grid]', err);
        showToast('We couldn\'t update your wishlist. Please try again.', { type: 'error' });
      }
    });

    anchor.dataset.wired = '1';
  }

  // --- wire all cards currently in DOM ---
  function wireAllCards(root = document) {
    root.querySelectorAll('.product-m').forEach(wireCard);
  }

  // --- bootstrap: sync once, wire now, then watch for re-renders/pagination ---
  document.addEventListener('DOMContentLoaded', async () => {
    await syncWishlistFromServer();
    wireAllCards();

    const grid = document.getElementById('product-grid');
    if (!grid) return;
    const mo = new MutationObserver(() => {
      // defer to next frame to avoid thrashing during bulk updates
      requestAnimationFrame(() => wireAllCards(grid));
    });
    mo.observe(grid, { childList: true, subtree: true });
  });
})();
</script>
    <!-- Dynamic Product Loading Script -->
    <script>
    (async () => {
        // Configuration
        const DEBUG = true;
        const log = (...args) => DEBUG && console.log('[DEBUG]', ...args);
        const PRODUCTS_API = `${API_ROOT}/products`; // Use global API_ROOT
        const DEFAULT_PAGE_SIZE = 9; // 3x3 grid per page
        let pageSize = DEFAULT_PAGE_SIZE;
        const IMAGE_FALLBACK = '';

        // Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const productGrid = document.getElementById('product-grid');
        const pagination = document.getElementById('pagination');
        const resultsCount = document.getElementById('results-count');
        const filterTree = document.getElementById('filter-tree');
        const relatedSearches = document.getElementById('related-searches');
        const pageSizeSelect = document.getElementById('page-size');

        const initialPageSize = parseInt(pageSizeSelect?.value.replace(/\D+/g, ''), 10);
        if (!Number.isNaN(initialPageSize) && initialPageSize > 0) {
            pageSize = initialPageSize;
        }

        // State
        const baseTitle = document.title;
        let products = [];
        let filteredProducts = [];
        let currentPage = 1;
        let currentFilter = {};
        let activeSpecial = '';
        let productsLoaded = false;

        const initialSpecial = (new URLSearchParams(window.location.search).get('special') || '').trim();
        if (initialSpecial) {
            activeSpecial = initialSpecial;
        } else if (window.__pendingSpecial) {
            activeSpecial = window.__pendingSpecial;
        }

        // Helper Functions
        function showLoading() {
            if (productGrid) {
                const skeleton = `
                    <div class="col-lg-4 col-md-6 col-sm-6">
                        <div class="product-skeleton">
                            <div class="product-skeleton__media"></div>
                            <div class="product-skeleton__line"></div>
                            <div class="product-skeleton__line"></div>
                            <div class="product-skeleton__line product-skeleton__line--short"></div>
                        </div>
                    </div>`;
                productGrid.dataset.loading = 'true';
                productGrid.innerHTML = skeleton.repeat(6);
            }
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
            if (productGrid) {
                productGrid.removeAttribute('data-loading');
            }
        }

        function showError(message) {
            productGrid.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function formatPrice(price) {
            return Number(price).toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            });
        }

        function renderStars(rating) {
            rating = Number(rating) || 0;
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5 ? 1 : 0;
            const emptyStars = 5 - fullStars - halfStar;
            let starsHTML = '';
            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<i class="fas fa-star"></i>';
            }
            if (halfStar) {
                starsHTML += '<i class="fas fa-star-half-alt"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<i class="far fa-star"></i>';
            }
            return starsHTML;
        }

        function getAverageStars(reviewsText) {
            try {
                const arr = JSON.parse(reviewsText || '[]');
                if (!Array.isArray(arr) || !arr.length) return 0;
                const total = arr.reduce((sum, r) => sum + Number(r.star || 0), 0);
                return total / arr.length;
            } catch (_) {
                return 0;
            }
        }

        // ===============================================
        // THE NEW HELPER FUNCTION RIGHT HERE ðŸ‘‡
        // ===============================================
        function getImageUrl(product) {
            try {
                let primaryPath = '';
                const v = product.product_image_path;

                if (v) {
                    // This handles both new arrays and old JSON strings gracefully
                    const pathArray = Array.isArray(v) ? v : JSON.parse(v);
                    if (Array.isArray(pathArray) && pathArray.length > 0) {
                        primaryPath = pathArray[0];
                    }
                }
              
                if (primaryPath) {
                    // If it's a full S3 URL, use it directly. Otherwise, build the path.
                    return primaryPath.startsWith('http') ? primaryPath : `${API_HOST}/${primaryPath.replace(/^\/+/, '')}`;
                }
            } catch (e) {
                console.warn('Could not parse image path for product:', product.product_id);
            }
            return IMAGE_FALLBACK; // Return empty string if anything fails
        }

        function setSpecialCategory(name, fromInit = false) {
            const next = (name || '').trim();
            activeSpecial = next;

            if (!fromInit) {
                window.__pendingSpecial = null;
            }

            document.title = next ? `${next} â€“ ${baseTitle}` : baseTitle;
            currentFilter = {};
            currentPage = 1;

            if (!productsLoaded) {
                return;
            }

            buildFilterTree();
            applyFilters();
            renderProducts();
            updateResultsCount();
        }

        window.handleSpecialCategory = (name) => {
            setSpecialCategory(name);
        };


        // Data Fetching
        async function fetchProducts() {
            showLoading();
            try {
                log('Fetching products from API...');
                const response = await fetch(PRODUCTS_API);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                products = await response.json();
                log(`Fetched ${products.length} products`);
                products.sort((a, b) => {
                    const indexA = Number(a.product_index) || 0;
                    const indexB = Number(b.product_index) || 0;
                    return indexA - indexB;
                });
                productsLoaded = true;
                buildFilterTree();
                if (activeSpecial) {
                    setSpecialCategory(activeSpecial, true);
                } else {
                    applyFilters();
                    renderProducts();
                    updateResultsCount();
                }
                window.__pendingSpecial = null;
            } catch (error) {
                console.error('Error fetching products:', error);
                showError('Could not load products. Please try again later.');
                showGlobalError("We're having trouble loading products. Please refresh the page.");
            } finally {
                hideLoading();
            }
        }

        
        // Filter Tree
        function buildFilterTree() {
            if (!products.length) return;
            const treeFields = Object.keys(products[0])
                .filter(key => /^product_tree\d+$/.test(key))
                .sort((a, b) => parseInt(a.match(/\d+$/)[0]) - parseInt(b.match(/\d+$/)[0]));
            const categoryTree = {};
            products.forEach(product => {
                let current = categoryTree;
                treeFields.forEach((field, idx) => {
                    const value = product[field] || 'Uncategorized';
                    if (idx === treeFields.length - 1) {
                        if (!current[value]) current[value] = true;
                    } else {
                        if (!current[value]) current[value] = {};
                        current = current[value];
                    }
                });
            });

            function renderNode(node, level) {
                let html = '<ul>';
                Object.keys(node).sort().forEach(key => {
                    const hasChildren = node[key] && typeof node[key] === 'object';
                    const field = treeFields[level];
                    const isActive = currentFilter[field] === key;
                    html += `<li class="${hasChildren ? 'has-list' : ''} ${isActive ? 'is-expanded' : ''}">` +
                            `<a href="#" class="f-link" data-type="${field}" data-value="${key}">${key}</a>`;
                    if (hasChildren) {
                        html += `<span class="js-shop-category-span ${isActive ? 'fas fa-minus' : 'fas fa-plus'} u-s-m-l-6"></span>`;
                        let childHtml = renderNode(node[key], level + 1);
                        if (!isActive) {
                            childHtml = childHtml.replace(/^<ul>/, '<ul style="display:none;">');
                        }
                        html += childHtml;
                    }
                    html += '</li>';
                });
                html += '</ul>';
                return html;
            }

            filterTree.innerHTML = renderNode(categoryTree, 0);
            document.querySelectorAll('.f-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const type = this.dataset.type;
                    const value = this.dataset.value;
                    const idx = treeFields.indexOf(type);
                    if (currentFilter[type] === value) {
                        treeFields.slice(idx).forEach(f => currentFilter[f] = null);
                    } else {
                        currentFilter[type] = value;
                        treeFields.slice(idx + 1).forEach(f => currentFilter[f] = null);
                    }
                    currentPage = 1;
                    applyFilters();
                    buildFilterTree();
                    renderProducts();
                    updateResultsCount();
                });
            });
        }

        function applyFilters() {
            if (!products.length) {
                filteredProducts = [];
                return;
            }

            const treeFields = Object.keys(products[0]).filter(k => /^product_tree\d+$/.test(k));
            const activeSpecialLower = activeSpecial.toLowerCase();

            filteredProducts = products.filter(product => {
                if (activeSpecialLower) {
                    const productSpecial = String(product.product_special_description || '').trim().toLowerCase();
                    if (productSpecial !== activeSpecialLower) {
                        return false;
                    }
                }

                return treeFields.every(field => {
                    const val = currentFilter[field];
                    return !val || product[field] === val;
                });
            });
        }

        function updateResultsCount() {
            const count = filteredProducts.length;
            const suffix = activeSpecial ? ` in ${activeSpecial}` : '';
            resultsCount.textContent = `FOUND ${count} RESULT${count !== 1 ? 'S' : ''}${suffix}`;

            const chips = [];
            if (currentFilter.tree1) {
                chips.push(`<a class="gl-tag btn--e-brand-shadow" href="#">${currentFilter.tree1}</a>`);
            }
            if (currentFilter.tree2) {
                chips.push(`<a class="gl-tag btn--e-brand-shadow" href="#">${currentFilter.tree2}</a>`);
            }
            if (currentFilter.tree3) {
                chips.push(`<a class="gl-tag btn--e-brand-shadow" href="#">${currentFilter.tree3}</a>`);
            }
            if (activeSpecial) {
                chips.push(`<a class="gl-tag btn--e-brand-shadow" href="#">${activeSpecial}</a>`);
            }

            if (chips.length) {
                relatedSearches.innerHTML = `<span>Related Searches:</span>${chips.join('')}`;
            } else {
                relatedSearches.innerHTML = '';
            }
        }

        // Product Rendering
        function renderProducts() {
            if (filteredProducts.length === 0) {
                const emptyMessage = activeSpecial
                    ? `No products found for ${activeSpecial}.`
                    : 'No products found matching your criteria';
                productGrid.innerHTML = `<div class="col-12 no-products">${emptyMessage}</div>`;
                pagination.innerHTML = '';
                return;
            }

            const totalPages = Math.ceil(filteredProducts.length / pageSize) || 1;
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredProducts.length);
            const pageProducts = filteredProducts.slice(startIndex, endIndex);

            let html = '';
            pageProducts.forEach(product => {
                const saleBadge = product.product_sale === '1'
                    ? '<div class="product-m__sale-badge"><span class="u-s-m-b-4 d-block">SALE</span></div>'
                    : '';
                // ADD THIS ONE LINE IN ITS PLACE
                const imagePath = getImageUrl(product);
                const price = Number(product.product_price) || 0;
                const discountPct = Number(product.product_discount) || 0;
                const hasDiscount = discountPct > 0;
                const discountedPrice = hasDiscount ? price * (1 - discountPct / 100) : price;
                const avgStars = getAverageStars(product.product_reviews);
                const priceHTML = hasDiscount
                    ? `<span class="product-m__price-discounted">${formatPrice(discountedPrice)}</span> <span class="product-m__discount">${formatPrice(price)}</span>`
                    : `<span class="product-m__price">${formatPrice(price)}</span>`;

                html += `
                <div class="col-lg-4 col-md-6 col-sm-6">
                    <div class="product-m">
                        <div class="product-m__thumb">
                            ${saleBadge}
                            <a class="aspect aspect--bg-grey aspect--square u-d-block" href="product-detail-variable.html?product_id=${product.product_id}&image=${encodeURIComponent(imagePath)}">
                                <img class="aspect__img" src="${imagePath}" alt="${product.product_name}">
                            </a>
                            <div class="product-m__quick-look">
                                <a class="fas fa-search" data-modal="modal" data-modal-id="#quick-look" data-tooltip="tooltip" data-placement="top" title="Quick Look"></a>
                            </div>
                            <div class="product-m__add-cart">
                                <a class="btn--e-brand" data-modal="modal" data-modal-id="#add-to-cart">Add to Cart</a>
                            </div>
                        </div>
                        <div class="product-m__content">
                            <div class="product-m__category">
                                <a href="shop-side-version-2.html">${product.product_tree1 || 'General'}</a>
                            </div>
                            <div class="product-m__name">
                                <a href="product-detail-variable.html?product_id=${product.product_id}&image=${encodeURIComponent(imagePath)}">
                                    ${product.product_name || 'Product'}
                                </a>
                            </div>
                            <div class="product-m__rating gl-rating-style">
                                ${renderStars(avgStars)}
                                <span class="product-m__review"></span>
                            </div>
                            <div class="product-m__price">
                                ${priceHTML}
                            </div>
                            <div class="product-m__hover">
                                <div class="product-m__preview-description">
                                    <span>${product.product_description || 'No description available'}</span>
                                </div>
                                <div class="u-s-m-b-15">
                                <div class="pd-detail__inline">
                                    <span class="pd-detail__click-wrap">
                                    <a id="pd-wishlist-btn" href="#" class="pd-wishlist-link" data-tooltip="tooltip" title="Add to Wishlist">
                                        <i id="pd-wishlist-icon" class="far fa-heart u-s-m-r-6"></i>
                                        <span id="pd-wishlist-text">Add to Wishlist</span>
                                    </a>
                                    <span class="pd-detail__click-count" id="pd-wishlist-count">(0)</span>
                                    </span>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });

            productGrid.innerHTML = html;
            renderPagination(totalPages);
        }
        
        function renderPagination(totalPages) {
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            let html = '';
            const maxPagesToShow = 5;
            let startPage, endPage;
            if (totalPages <= maxPagesToShow) {
                startPage = 1;
                endPage = totalPages;
            } else {
                const maxPagesBeforeCurrent = Math.floor(maxPagesToShow / 2);
                const maxPagesAfterCurrent = Math.ceil(maxPagesToShow / 2) - 1;
                if (currentPage <= maxPagesBeforeCurrent) {
                    startPage = 1;
                    endPage = maxPagesToShow;
                } else if (currentPage + maxPagesAfterCurrent >= totalPages) {
                    startPage = totalPages - maxPagesToShow + 1;
                    endPage = totalPages;
                } else {
                    startPage = currentPage - maxPagesBeforeCurrent;
                    endPage = currentPage + maxPagesAfterCurrent;
                }
            }
            if (currentPage > 1) {
                html += `<li><a href="#" data-page="${currentPage - 1}"><i class="fas fa-angle-left"></i></a></li>`;
            }
            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="${i === currentPage ? 'is-active' : ''}">` +
                        `<a href="#" data-page="${i}">${i}</a></li>`;
            }
            if (currentPage < totalPages) {
                html += `<li><a href="#" data-page="${currentPage + 1}"><i class="fas fa-angle-right"></i></a></li>`;
            }
            pagination.innerHTML = html;
            document.querySelectorAll('#pagination a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentPage = parseInt(this.dataset.page);
                    renderProducts();
                    updateResultsCount();
                });
            });
        }

        // Initialization
        fetchProducts();

        // Sort event listener
        document.getElementById('sort-by').addEventListener('change', function() {
            const sortBy = this.value;
            if (sortBy.includes('Price')) {
                filteredProducts.sort((a, b) => {
                    const priceA = parseFloat(a.product_price) || 0;
                    const priceB = parseFloat(b.product_price) || 0;
                    return sortBy.includes('Lowest') ? priceA - priceB : priceB - priceA;
                });
            } else if (sortBy.includes('Newest') || sortBy.includes('Latest')) {
                filteredProducts.sort((a, b) => {
                    const indexA = parseInt(a.product_index) || 0;
                    const indexB = parseInt(b.product_index) || 0;
                    return indexB - indexA;
                });
            } else if (sortBy.includes('Rating')) {
                filteredProducts.sort((a, b) => {
                    const ratingA = getAverageStars(a.product_reviews);
                    const ratingB = getAverageStars(b.product_reviews);
                    return ratingB - ratingA;
                });
            }
            currentPage = 1;
            renderProducts();
            updateResultsCount();
        });

        // Page size event listener
        pageSizeSelect?.addEventListener('change', function() {
            const value = parseInt(this.value.replace(/\D+/g, ''), 10);
            if (!Number.isNaN(value) && value > 0) {
                pageSize = value;
            }
            currentPage = 1;
            renderProducts();
            updateResultsCount();
        });

        const viewToggleButtons = document.querySelectorAll('.tool-style__group span');
        const syncToggleState = () => {
            viewToggleButtons.forEach(btn => {
                btn.setAttribute('aria-pressed', btn.classList.contains('is-active'));
            });
        };

        viewToggleButtons.forEach(btn => {
            btn.addEventListener('click', syncToggleState);
            btn.addEventListener('keydown', evt => {
                if (evt.key === 'Enter' || evt.key === ' ') {
                    evt.preventDefault();
                    btn.click();
                }
            });
        });

        syncToggleState();
    })();
    </script>

    <!-- Noscript -->
    <noscript>
        <div class="app-setting">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="app-setting__wrap">
                            <h1 class="app-setting__h1">JavaScript is disabled in your browser.</h1>
                            <span class="app-setting__text">Please enable JavaScript in your browser or upgrade to a JavaScript-capable browser.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </noscript>


</body>
</html>
